
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RTK ‚Äî Admin Orders</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --accent:#d9464a; --muted:#6b7280; --card:#fff;
      --shadow: 0 8px 24px rgba(15,23,42,0.06);
      font-family: 'Nunito', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    body{margin:0;background:#faf9f8;color:#111}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;z-index:10}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:22px}
    .muted{color:var(--muted)}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{padding:8px 12px;border-radius:8px;border:1px solid #e8e6e6;background:#fff;cursor:pointer;font-weight:700}
    .btn-accent{background:var(--accent);color:#fff;border-color:var(--accent)}
    main .wrap{padding-top:16px}
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    thead th{font-size:13px;color:var(--muted);text-align:left;padding:0 10px}
    tbody tr{background:#fff;box-shadow:var(--shadow)}
    td{padding:12px 10px;vertical-align:top}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #eee;background:#fff}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px}
    .small{font-size:13px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .row{border-radius:12px}
    .expander{cursor:pointer;color:var(--accent);font-weight:700}
    .details{display:none;border-top:1px dashed #eee;margin-top:8px;padding-top:10px}
    .line{display:flex;justify-content:space-between;gap:10px}
    .line small{color:var(--muted)}
    .nowrap{white-space:nowrap}
    .badge{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border:1px solid #eee;border-radius:999px;background:#fff;font-size:12px}
    .allergens{display:flex;gap:6px;flex-wrap:wrap}
  
  /* Everything inside here only affects printing */
  @media print {

    /* General font sizing for print */
    body {
      font-size: 14pt;              /* bump this up or down as you like */
      line-height: 1.4;
    }

    /* Limit content width to suit 80mm paper */
    .order-print-area {
      max-width: 80mm;
    }

    /* Hide anything that shouldn't appear on the printout */
    .no-print,
    .admin-header,
    .sidebar,
    .footer,
    .buttons-row,
    .search-bar {
      display: none !important;
    }

    /* Optional: remove background colours and images */
    * {
      background: transparent !important;
      box-shadow: none !important;
    }

    /* Tidy up links (no underlines / URLs) */
    a {
      text-decoration: none !important;
    }

    /* Make key sections clearer / bigger */
    .order-main-heading {
      font-size: 18pt;
      font-weight: bold;
    }

    .order-items-table {
      font-size: 13pt;
    }

    .order-totals {
      font-size: 14pt;
      font-weight: bold;
    }
  }
  
		  /* New order toast */
		.new-order-toast {
		  position: fixed;
		  top: 16px;
		  right: 16px;
		  background: #16205b;
		  color: #fff;
		  padding: 10px 14px;
		  border-radius: 8px;
		  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
		  font-size: 14px;
		  z-index: 99999;
		  opacity: 0;
		  transform: translateY(-8px);
		  transition: opacity 0.25s ease, transform 0.25s ease;
		}

		.new-order-toast.show {
		  opacity: 1;
		  transform: translateY(0);
		}
		
		.new-order-banner {
		  position: fixed;
		  bottom: 20px;
		  right: 20px;
		  background: #16205b;
		  color: #fff;
		  padding: 10px 14px;
		  border-radius: 10px;
		  box-shadow: 0 4px 12px rgba(0,0,0,0.25);
		  font-size: 14px;
		  display: flex;
		  align-items: center;
		  gap: 10px;
		  z-index: 99999;
		}

		.new-order-banner button {
		  background: #d9464a;
		  color: #fff;
		  border: none;
		  border-radius: 999px;
		  padding: 6px 12px;
		  cursor: pointer;
		  font-size: 13px;
		  font-weight: 600;
		}

		.new-order-banner button:hover {
		  opacity: 0.9;
		}

		.status-pill {
		  display: inline-block;
		  padding: 4px 8px;
		  border-radius: 999px;
		  font-size: 11px;
		  font-weight: 700;
		  text-transform: uppercase;
		  letter-spacing: 0.04em;
		}

		/* Colours per status */
		.status-pending {
		  background: #fee2e2;
		  color: #b91c1c;
		}
		.status-confirmed {
		  background: #fef3c7;
		  color: #92400e;
		}
		.status-preparing {
		  background: #dbeafe;
		  color: #1d4ed8;
		}
		.status-completed {
		  background: #dcfce7;
		  color: #166534;
		}
		.status-cancelled {
		  background: #e5e7eb;
		  color: #374151;
		}
		/* Drag-over highlight */
		.column.drop-target {
		  outline: 2px dashed #fbbf24;
		  outline-offset: 4px;
		}

		.order-card.dragging {
		  opacity: 0.6;
		}
		td.actions {
		  white-space: nowrap;
		}

		.btn-small {
		  font-size: 0.8rem;
		  padding: 4px 6px;
		  margin-left: 4px;
		}

		.btn-accept {
		  background: #2e7d32;
		  color: #fff;
		}

		.btn-decline {
		  background: #c62828;
		  color: #fff;
		}

		.btn-suggest {
		  background: #f9a825;
		  color: #000;
		}

		.btn-paid {
		  background: #1565c0;
		  color: #fff;
		}
		
		.filter-today {
		  display: inline-flex;
		  align-items: center;
		  gap: 6px;
		  font-size: 13px;
		  color: var(--muted);
		  padding: 6px 10px;
		  border-radius: 999px;
		  border: 1px solid #e5e7eb;
		  background: #f9fafb;
		  cursor: pointer;
		}
		.filter-today input {
		  margin: 0;
		}
		
		.details a.details-link {
		  color: var(--accent);
		  text-decoration: underline;
		  font-size: 12px;
		}

		.status-completed {
		  background: #e5e7eb;
		  color: #111827;
		}

			tr.row-attention td {
			  background-color: #ffe9c6 !important;
			}
			tr.row-attention:hover td {
			tr.row-attention td {
  background-color: #ffe9c6 !important;
}

/* Highlight future orders - force it to win over existing styles */
	tbody#tbody tr.row-attention > td { background: #ffe9c6 !important; }
	tbody#tbody tr.row-attention:hover > td { background: #ffd89a !important; }



  
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h1>Rung‚Äôs Thai Kitchen ‚Äî Orders</h1>
        <div class="muted small">Live dashboard (auto-updates)</div>
      </div>
      <div class="controls">
  <button id="refresh" class="btn">Refresh</button>
  <button id="export" class="btn">Export CSV</button>

  <label class="filter-today">
    <input type="checkbox" id="filter-today" checked />
    Today only
  </label>
</div>


    </div>
  </header>

  <main>
    <div class="wrap">
      <table>
        <thead>
          <tr>
			<th>RTK Ref</th>
            <!--<th>Order</th>-->
            <th>Booking Time</th>
            <th>Customer</th>
            <th>Type</th>
			<th>Status</th>
            <th class="nowrap">Subtotal</th>
            <th class="nowrap">Delivery</th>
            <th class="nowrap">Total</th>
            <th style="text-align:right">Actions</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <!-- rows injected here -->	
        </tbody>
      </table>
      <div id="empty" class="muted" style="margin-top:12px;display:none">No orders yet.</div>
    </div>
  </main>
  <audio id="new-order-sound" src="Sounds/bell railroad1.wav" preload="auto"></audio>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ---------- Config ----------
    const SUPABASE_URL = 'https://ubyjrrsvbbqomitpaidb.supabase.co';
	const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVieWpycnN2YmJxb21pdHBhaWRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5NTYyNjMsImV4cCI6MjA3NjUzMjI2M30.WTllxO5KnaMI0i1d4VHNBhjLuRMfu4_Xx5arqZmYevw';

		// do this ONCE
		window.supabaseClient = window.supabaseClient
		  || window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

		// then everywhere else:
		const sb = window.supabaseClient;
		
		let showTodayOnly = true;

document.addEventListener("DOMContentLoaded", () => {
  const cb = document.getElementById("filter-today");
  if (!cb) {
    console.error("Checkbox #filter-today not found");
    return;
  }

  // Force default ON on every load
  showTodayOnly = true;
  cb.checked = true;
  localStorage.setItem("showTodayOnly", "true");

  cb.addEventListener("change", () => {
    showTodayOnly = cb.checked;
    localStorage.setItem("showTodayOnly", showTodayOnly ? "true" : "false");
    render(getFilteredOrders());
  });

  console.log("[today-only] init:", {
    saved: localStorage.getItem("showTodayOnly"),
    checked: cb.checked,
    showTodayOnly
  });
});


	
	// ---- Restaurant location (centre point for distance) ----
// Replace with your real coordinates from Google Maps:
const RESTAURANT_LAT = 53.74433548441447;  // <--- your real latitude
const RESTAURANT_LNG = -1.5766076562010034;  // <--- your real longitude

// ---- Haversine distance helper (returns km) ----
function distanceKmBetween(lat1, lon1, lat2, lon2) {
  if (
    lat1 == null || lon1 == null ||
    lat2 == null || lon2 == null
  ) {
    return null;
  }

  const R = 6371; // Earth radius in km
  const toRad = (deg) => (deg * Math.PI) / 180;

  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);

  const a =
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(toRad(lat1)) *
      Math.cos(toRad(lat2)) *
      Math.sin(dLon / 2) * Math.sin(dLon / 2);

  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

  return R * c; // distance in km
}

	
		// ---- Call Edge Function to geocode a single order's address ----
		async function geocodeOrder(order) {
		  const type = (order.order_type || "").toLowerCase();
		  const c = order.customers || {};

		  // Prefer customers.address; fall back to orders.delivery_address
		  const address = c.address || order.delivery_address;

		  console.log("[geocodeOrder] start", {
			id: order.id,
			type,
			address,
			customer_lat: order.customer_lat,
			customer_lng: order.customer_lng,
		  });

		  // Only for delivery orders
		  if (type !== "delivery") {
			console.log("[geocodeOrder] not a delivery order, skipping");
			return;
		  }

		  if (!address) {
			console.warn("[geocodeOrder] No address to geocode for order", order.id);
			return;
		  }

		  try {
			const { data, error } = await sb.functions.invoke("geocode-order", {
			  body: {
				order_id: order.id,
				customer_address: address,
			  },
			});

			console.log("[geocodeOrder] invoke result", { data, error });

			if (error) {
			  console.error("[geocodeOrder] invoke error", error);
			  return;
			}

			if (data) {
			  console.log(
				"[geocodeOrder] success, coords saved to DB",
				data.customer_lat,
				data.customer_lng
			  );
			}
		  } catch (err) {
			console.error("[geocodeOrder] Error calling geocode-order:", err);
		  }
		}



	
		const ordersChannel = sb.channel('orders-realtime')
	  .on(
		'postgres_changes',
		{ event: 'INSERT', schema: 'public', table: 'orders' },
		payload => {
		  console.info('Realtime: new order', payload.new);
		  loadAndRender();
		}
	  )
	  .on(
		'postgres_changes',
		{ event: 'UPDATE', schema: 'public', table: 'orders' },
		payload => {
		  console.info('Realtime: order updated', payload.new);
		  loadAndRender();
		}
	  )
	  .subscribe();

		let currentOrders = [];

		function isSameDay(a, b) {
		  return (
			a.getFullYear() === b.getFullYear() &&
			a.getMonth() === b.getMonth() &&
			a.getDate() === b.getDate()
		  );
		}

		function getFilteredOrders() {
		  if (!showTodayOnly) return currentOrders;

		  const today = new Date();
		  const y = today.getFullYear();
		  const m = today.getMonth();
		  const d = today.getDate();

		  return currentOrders.filter(o => {
			const dt = getBookingDate(o); // booking time (preferred/proposed/created)
			if (!dt) return false;
			return (
			  dt.getFullYear() === y &&
			  dt.getMonth() === m &&
			  dt.getDate() === d
			);
		  });
		}


		

	// --- AUDIO + NEW-ORDER ALERT STATE ---------------------------------

	let audioUnlocked = false;
	let firstLoadDone = false;
	let lastSeenCreatedAt = null;

	// Orders we still haven't acknowledged this session
	const unacknowledgedOrders = new Map();   // id -> order
	const acknowledgedOrderIds = new Set();   // ids we've already acknowledged

	// Unlock audio on first user interaction (for autoplay policies)
	function unlockAudioOnce() {
	  const audio = document.getElementById('new-order-sound');
	  if (!audio || audioUnlocked) return;

	  audio.play().then(() => {
		audio.pause();
		audio.currentTime = 0;
		audioUnlocked = true;
		document.removeEventListener('click', unlockAudioOnce);
		document.removeEventListener('keydown', unlockAudioOnce);
		console.info('New-order sound unlocked');
	  }).catch(err => {
		console.warn('Audio unlock failed:', err);
	  });
	}

	document.addEventListener('click', unlockAudioOnce);
	document.addEventListener('keydown', unlockAudioOnce);

	// Show a banner with Acknowledge button when there are unacknowledged orders
	function showNewOrderBanner() {
	  const count = unacknowledgedOrders.size;
	  if (!count) return;

	  let banner = document.getElementById('new-order-banner');
	  if (!banner) {
		banner = document.createElement('div');
		banner.id = 'new-order-banner';
		banner.className = 'new-order-banner';
		document.body.appendChild(banner);
	  }

	  const text = count === 1
		? '1 new order awaiting acknowledgement'
		: `${count} new orders awaiting acknowledgement`;

	  banner.innerHTML = `
		<span>üîî ${text}</span>
		<button type="button" id="ack-new-orders-btn">Acknowledge</button>
	  `;

	  const btn = document.getElementById('ack-new-orders-btn');
	  if (btn) {
		btn.onclick = acknowledgeNewOrders;
	  }
	}

	function acknowledgeNewOrders() {
	  // Mark all as acknowledged for this session
	  unacknowledgedOrders.forEach((order) => {
		acknowledgedOrderIds.add(order.id);
	  });
	  unacknowledgedOrders.clear();

	  const banner = document.getElementById('new-order-banner');
	  if (banner) banner.remove();
	}
	
				// ---- Desktop notification helpers ----
			async function ensureNotificationPermission() {
			  try {
				if (!("Notification" in window)) {
				  console.warn("Browser does not support notifications.");
				  return false;
				}
				if (Notification.permission === "granted") return true;
				if (Notification.permission === "denied") return false;

				const perm = await Notification.requestPermission();
				return perm === "granted";
			  } catch (e) {
				console.error("Notification permission error:", e);
				return false;
			  }
			}

			function showNewOrderNotification(order) {
			  if (!("Notification" in window)) return;

			  const rtkRef = order.order_ref || `RTK-${String(order.id).slice(0, 8)}`;
			  const orderType = (order.order_type || "collection").toUpperCase();

			  const title = `New order ${rtkRef}`;
			  const bodyLines = [];

			  bodyLines.push(orderType);
			  const c = order.customers || {};
			  if (c.full_name) bodyLines.push(c.full_name);
			  if (order.preferred_time) {
				const d = new Date(order.preferred_time);
				if (!Number.isNaN(d.getTime())) {
				  bodyLines.push(
					"Time: " +
					  d.toLocaleString([], { dateStyle: "short", timeStyle: "short" })
				  );
				}
			  }

			  const body = bodyLines.join("\n");

			  try {
				const n = new Notification(title, {
				  body,
				  // icon: "/some-icon.png", // optional if you add one later
				});

				// Optional: click brings admin tab to front
				n.onclick = () => {
				  window.focus();
				};
			  } catch (e) {
				console.error("Failed to show notification:", e);
			  }
			}

			// ask for permission once when admin page loads
			ensureNotificationPermission();


		// Handle brand new orders + repeat alerts for unacknowledged ones
		function handleNewOrders(newOrders) {
		  const list = newOrders || [];

		  // 1) Add any *brand new* orders into the unacknowledged set
		  list.forEach(o => {
			if (!unacknowledgedOrders.has(o.id)) {
			  unacknowledgedOrders.set(o.id, o);
			}
		  });

		  // 2) If there are NO unacknowledged orders, nothing to do
		  if (unacknowledgedOrders.size === 0) return;

		  // 3) Play sound (if unlocked)
		  const audio = document.getElementById('new-order-sound');
		  if (audio && audioUnlocked) {
			audio.play().catch(err => {
			  console.warn('New-order sound play failed:', err);
			});
		  }

		  // 4) Show / update banner
		  showNewOrderBanner();

		  // 5) üîî Desktop notifications for these *brand new* ones
		  list.forEach(o => {
			showNewOrderNotification(o);
		  });
		}

			
			function money(n) {
			  const x = Number(n);
			  return Number.isFinite(x) ? x : 0;
			}

			function getOrderTotals(o) {
			  const subtotal = money(o.subtotal);
			  const discount = money(o.discount);
			  const delivery = money(o.delivery_fee);

			  // Prefer stored total if present
			  const storedTotal = money(o.total);
			  const total = (storedTotal > 0)
				? storedTotal
				: Math.round((subtotal - discount + delivery) * 100) / 100;

			  return { subtotal, discount, delivery, total };
			}

			function sumTotal(order) {
			  const storedTotal = Number(order.total);
			  if (Number.isFinite(storedTotal) && storedTotal > 0) return storedTotal;

			  const subtotal = Number(order.subtotal || 0);
			  const discount = Number(order.discount || 0);
			  const delivery = Number(order.delivery_fee || 0);

			  return Math.round((subtotal - discount + delivery) * 100) / 100;
			}


		function fmtDate(value) {
		  if (!value) return '‚Äî';
		  try {
			return new Date(value).toLocaleString('en-GB', {
			  dateStyle: 'short',
			  timeStyle: 'short'
			});
		  } catch (e) {
			console.warn('Bad date value:', value, e);
			return String(value);
		  }
		}

		function fmtMoney(value) {
		  const num = Number(value || 0);
		  try {
			return new Intl.NumberFormat('en-GB', {
			  style: 'currency',
			  currency: 'GBP',
			  minimumFractionDigits: 2,
			  maximumFractionDigits: 2
			}).format(num);
		  } catch (e) {
			console.warn('Bad money value:', value, e);
			return `¬£${num.toFixed(2)}`;
		  }
		}

			function fmtDisplayTime(o) {
			  const preferred = o.preferred_time;
			  const proposed  = o.proposed_time;
			  const asap      = o.asap_requested;

			  let raw = null;
			  let suffix = "";

			  if (preferred) {
				raw = preferred;
			  } else if (proposed) {
				raw = proposed;
				suffix = " (proposed)";
			  } else if (asap) {
				return "ASAP (no time set)";
			  } else {
				return "No time set";
			  }

			  const d = new Date(raw);
			  if (Number.isNaN(d.getTime())) {
				return "No time set";
			  }

			  const formatted = d.toLocaleString([], {
				dateStyle: "short",
				timeStyle: "short",
			  });

			  return formatted + suffix;
			}


		function parseUkDateTime(raw) {
  // Accepts: "24/12/2025, 20:15" or "24/12/2025 20:15" or "24/12/2025"
  const s = String(raw).trim();

  const m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})(?:[,\s]+(\d{2}):(\d{2}))?$/);
  if (!m) return null;

  const dd = Number(m[1]);
  const mm = Number(m[2]);
  const yyyy = Number(m[3]);
  const HH = m[4] ? Number(m[4]) : 0;
  const MIN = m[5] ? Number(m[5]) : 0;

  // Create a local Date (UK browsers will treat this as local time)
  const d = new Date(yyyy, mm - 1, dd, HH, MIN, 0, 0);
  if (Number.isNaN(d.getTime())) return null;
  return d;
}

function getBookingDate(o) {
  // Try the likely booking/scheduled fields first, then created_at last.
  const raw =
    o.preferred_time ||
    o.proposed_time ||
    o.scheduled_for ||
    o.requested_for ||
    o.booking_time ||
    o.booking_datetime ||
    o.delivery_time ||
    o.collection_time ||
    o.created_at;

  if (!raw) return null;

  // 1) Try normal Date parsing (ISO timestamps etc.)
  let d = new Date(raw);
  if (!Number.isNaN(d.getTime())) return d;

  // 2) Try UK format parsing (dd/mm/yyyy, hh:mm)
  d = parseUkDateTime(raw);
  if (d) return d;

  return null;
}


		
		function isFutureUkDay(o) {
  const d = getBookingDate(o);
  if (!d) return false;

  // Today (UK = UTC in winter)
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  // Booking day
  const bookingDay = new Date(d);
  bookingDay.setHours(0, 0, 0, 0);

  return bookingDay > today;
}



function buildDetailsHTML(o) {
  const c = o.customers || {};
  const lines = (o.order_items || []).map(item => {
    const mods = (item.modifiers || []).map(m => m.name).join(', ');
    const spice = (item.spice == null)
      ? ''
      : (' ' + 'üå∂Ô∏è'.repeat(Math.max(0, Math.min(3, Number(item.spice)))));
    const modsFrag = mods
      ? `<div class="small muted">Mods: ${mods}</div>`
      : '';
    const img = item.img
      ? `<img src="${item.img}" alt="${item.name}" style="width:60px;height:60px;object-fit:cover;border-radius:8px;border:1px solid #eee;margin-right:8px">`
      : '';

    return `
      <div class="line">
        <div style="display:flex;align-items:center;gap:8px">
          ${img}
          <div>
            <div><strong>${item.name}</strong> √ó ${item.qty}${spice}</div>
            ${modsFrag}
          </div>
        </div>
        <div><strong>${fmtMoney(Number(item.unit_price) * Number(item.qty))}</strong></div>
      </div>
    `;
  }).join('');

  // Address + "View on map" link
  const addr = [c.address].filter(Boolean).join('<br>');
  const rawAddress = (c.address || '').replace(/\s+/g, ' ').trim();
  const mapUrl = rawAddress
    ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(rawAddress)}`
    : '';

  // ---- Distance text for delivery orders ----
  let distanceHTML = '';
  if (
    (o.order_type || '').toLowerCase() === 'delivery' &&
    o.customer_lat != null &&
    o.customer_lng != null
  ) {
    const km = distanceKmBetween(
      RESTAURANT_LAT,
      RESTAURANT_LNG,
      o.customer_lat,
      o.customer_lng
    );

    if (km != null && !Number.isNaN(km)) {
      distanceHTML = `<div class="small">Approx distance: ${km.toFixed(1)} km</div>`;
    }
  }

  // ---- Money (discount-aware) ----
  const subtotal = Number(o.subtotal || 0);
  const discount = Number(o.discount || 0);
  const delivery = Number(o.delivery_fee || 0);

  // Prefer stored total, otherwise derive it
  const total =
    (Number(o.total) > 0)
      ? Number(o.total)
      : Math.round((subtotal - discount + delivery) * 100) / 100;

  const discountLine =
    (discount > 0)
      ? `<div class="small">${o.discount_label || 'Discount'}: <span style="color:#198754"><strong>-¬£${discount.toFixed(2)}</strong></span></div>`
      : '';

  return `
    <div class="grid" style="margin-bottom:8px">
      <div>
        <div class="muted small">Customer</div>
        <div><strong>${c.full_name || '‚Äî'}</strong></div>
        <div class="small">${c.phone || ''}</div>
        <div class="small">${c.email || ''}</div>
      </div>
      <div>
        <div class="muted small">Address</div>
        <div class="small">
          ${addr || '‚Äî'}
          ${mapUrl
            ? `<div><a href="${mapUrl}" target="_blank" class="small details-link">View on map</a></div>`
            : ''
          }
        </div>
      </div>
      <div>
        <div class="muted small">Order</div>
        <div class="small">Type: <strong>${(o.order_type || 'collection').toUpperCase()}</strong></div>
        <div class="small">Subtotal: ${fmtMoney(subtotal)}</div>
        ${discountLine}
        <div class="small">Delivery: ${fmtMoney(delivery)}</div>
        <div class="small"><strong>Total: ${fmtMoney(total)}</strong></div>
        ${distanceHTML}
      </div>
    </div>
    <div class="muted small">Notes: ${o.notes ? o.notes : '‚Äî'}</div>
    <div style="margin-top:10px;border-top:1px dashed #eee;padding-top:10px">
      ${lines || '<div class="muted small">No items.</div>'}
    </div>
  `;
}





		const STATUS_LABELS = {
		  pending:   'Pending',
		  confirmed: 'Confirmed',
		  preparing: 'Preparing',
		  completed: 'Completed',
		  cancelled: 'Cancelled'
		};

			// ---------- Print ticket ----------
			function printTicket(o) {
		  const c = o.customers || {};
		  const items = o.order_items || [];

		  const rtkRef = o.order_ref || `RTK-${String(o.id).slice(0, 8)}`;

		  const rawTime = o.preferred_time || o.proposed_time || null;
		  const bookingTime = rawTime
			? new Date(rawTime).toLocaleString([], {
				dateStyle: "medium",
				timeStyle: "short",
			  })
			: "No time set";

		  const orderType = (o.order_type || "collection").toUpperCase();
		  const subtotal = Number(o.subtotal || 0);
		  const delivery = Number(o.delivery_fee || 0);
		  const total = subtotal + delivery;

		  // ESC/POS COMMANDS
		  const ESC = "\x1B";
		  const GS  = "\x1D";

		  const BIG = ESC + "!" + "\x38";   // Double height + double width + bold
		  const LARGE = ESC + "!" + "\x20"; // Double height
		  const NORMAL = ESC + "!" + "\x00";

		  let text = "";

		  // BIG RTK REF
		  text += BIG + rtkRef + "\n\n";

		  // Larger customer details
		  text += LARGE + (c.full_name || "") + "\n";
		  text += (c.phone || "") + "\n\n";

		  // Order type + time
		  text += LARGE + `TYPE: ${orderType}\n`;
		  text += `TIME: ${bookingTime}\n\n`;

		  // Address for delivery
		  if (orderType === "DELIVERY" && c.address) {
			text += LARGE + "ADDRESS:\n";
			text += NORMAL + c.address + "\n\n";
		  }

		  // Items
		  text += LARGE + "ITEMS:\n";
		  text += NORMAL;

		  items.forEach(it => {
			text += `${it.qty}√ó ${it.name}\n`;

			if (it.modifiers && it.modifiers.length) {
			  it.modifiers.forEach(m => {
				text += `   + ${m.name}\n`;
			  });
			}

			text += "\n";
		  });

		  // Notes
		  if (o.notes) {
			text += LARGE + "NOTES:\n";
			text += NORMAL + o.notes + "\n\n";
		  }

		  // Total
		  text += LARGE + `TOTAL: ¬£${total.toFixed(2)}\n\n`;

		  // Cut
		  text += GS + "V" + "\x00";

		  // ESCAPE FOR HTML
		  const safeText = text
			.replace(/&/g, "&amp;")
			.replace(/</g, "&lt;")
			.replace(/>/g, "&gt;");

		  // PRINT USING A POPUP
		 const w = window.open("", "PRINT", "height=800,width=600");
			  w.document.write(`
				<!doctype html>
				<html>
				  <head><title>${rtkRef}</title></head>
				  <body onload="window.focus(); window.print();">
					<pre style="
					  font-family: 'Courier New', monospace;
					  font-size: 22pt;
					  line-height: 1.4;
					  white-space: pre;
					  margin: 0;
					">${safeText}</pre>
				  </body>
				</html>
			  `);
			  w.document.close();
			}



	
// ---------- Render ----------
const tbody = document.getElementById('tbody');
const empty = document.getElementById('empty');

function render(orders) {
  tbody.innerHTML = '';

  if (!orders.length) {
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  orders.forEach(o => {
  const tr = document.createElement('tr');
  tr.classList.add('row');

  const isFuture = isFutureUkDay(o);
  if (isFuture) tr.classList.add('row-attention');

  const customer = o.customers || {};
  console.log('[ADMIN MONEY]', o.order_ref, { subtotal: o.subtotal, discount: o.discount, delivery_fee: o.delivery_fee, total: o.total });

  const rtkRef = o.order_ref || `RTK-${String(o.id).slice(0, 8)}`;

  const status = o.status || 'pending';
  const statusLabel = STATUS_LABELS[status] || status;

  // ---- correct money calculation (discount-aware) ----
  const subtotal = Number(o.subtotal || 0);
  const discount = Number(o.discount || 0);
  const delivery = Number(o.delivery_fee || 0);

  const finalTotal =
    (Number(o.total) > 0)
      ? Number(o.total)
      : Math.round((subtotal - discount + delivery) * 100) / 100;

  // data-* attributes (use the correct totals)
  tr.dataset.orderId = o.id;
  tr.dataset.orderRef = rtkRef;
  tr.dataset.name = customer.full_name || "";
  tr.dataset.email = customer.email || "";
  tr.dataset.phone = customer.phone || "";
  tr.dataset.total = finalTotal;              // ‚úÖ correct
  tr.dataset.subtotal = subtotal;             // ‚úÖ useful
  tr.dataset.discount = discount;             // ‚úÖ useful
  tr.dataset.deliveryFee = delivery;          // ‚úÖ useful
  tr.dataset.asapRequested = o.asap_requested ? "true" : "false";
  tr.dataset.communicationPreference = o.communication_preference || "email";
  tr.dataset.createdAt = o.created_at;
  tr.dataset.preferredTime = o.preferred_time || "";

  // ROW HTML
  tr.innerHTML = `
    <td class="mono">${rtkRef}</td>
    <td>${fmtDisplayTime(o)}</td>
    <td>
      <div><strong>${customer.full_name || '‚Äî'}</strong></div>
      <div class="small muted">${customer.phone || ''}</div>
    </td>
    <td><span class="pill">${(o.order_type || 'collection').toUpperCase()}</span></td>
    <td><span class="status-pill status-${status}">${statusLabel}</span></td>
    <td class="nowrap">${fmtMoney(subtotal)}</td>
    <td class="nowrap">${fmtMoney(delivery)}</td>
    <td class="nowrap"><strong>${fmtMoney(finalTotal)}</strong></td>
    <td class="actions" style="text-align:right">
      <button class="btn-small" data-action="toggle">Details</button>
      <button class="btn-small" data-action="print">Print</button>

      <div style="display:inline-flex;align-items:center;gap:4px;margin-left:8px">
        <input type="time"
               class="suggest-time-input"
               data-order-id="${o.id}"
               style="font-size:12px;padding:3px 4px">
        <button class="btn-small btn-suggest" data-order-id="${o.id}">Suggest</button>
      </div>

      <button class="btn-small btn-accept"  data-order-id="${o.id}">Accept</button>
      <button class="btn-small btn-decline" data-order-id="${o.id}">Decline</button>
      <button class="btn-small btn-paid"    data-order-id="${o.id}">Mark paid</button>
      <button class="btn-small btn-complete" data-order-id="${o.id}">Completed</button>
    </td>
  `;


    // ---- details row (your existing block) ----
    const details = document.createElement('div');
    details.className = 'details';
    details.innerHTML = buildDetailsHTML(o);

    const statusSelect = details.querySelector('.status-select');
    if (statusSelect) {
      statusSelect.addEventListener('change', async (e) => {
        const newStatus = e.target.value;
        const orderId = e.target.dataset.orderId;

        await updateOrderStatus(orderId, newStatus);
        loadAndRender();
      });
    }

    const detailsRow = document.createElement('tr');
    const detailsCell = document.createElement('td');
    detailsCell.colSpan = 9;
    detailsCell.appendChild(details);
    detailsRow.appendChild(detailsCell);

    const toggleBtn = tr.querySelector('[data-action="toggle"]');
    if (toggleBtn) {
      toggleBtn.addEventListener('click', () => {
        details.style.display = (details.style.display === 'block') ? 'none' : 'block';
      });
    }

    const printBtn = tr.querySelector('[data-action="print"]');
    if (printBtn) {
      printBtn.addEventListener('click', () => {
        printTicket(o);
      });
    }

    tbody.appendChild(tr);
    tbody.appendChild(detailsRow);
  });
}

async function updateOrderStatus(orderId, newStatus) {
  try {
    const { error } = await sb
      .from('orders')
      .update({ status: newStatus })
      .eq('id', orderId);

    if (error) {
      console.error('Error updating status', error);
      alert('Could not update status ‚Äì please try again.');
      return;
    }
  } catch (err) {
    console.error('Unexpected error updating status', err);
    alert('Unexpected error updating status');
  }
}



		// --- LOAD + RENDER WITH NEW-ORDER DETECTION ------------------------

					
			async function loadAndRender() {
			  const { data: orders, error } = await sb
			  .from('orders')
			  .select(`
				id,
				order_ref,
				created_at,
				proposed_time,
				asap_requested,
				preferred_time,
				order_type,
				subtotal,
				discount,
				discount_label,
				delivery_fee,
				total,
				notes,
				status,
				communication_preference,
				    customer_lat,
					customer_lng,
				customers (
				  full_name,
				  phone,
				  email,
				  address
				),
				order_items (
				  *
				)
			  `)
			  .order('created_at', { ascending: false });


		  if (error) {
			console.error('Error loading orders', error);
			return;
		  }
		 if (!orders) return;

		// üîπ Auto-geocode delivery orders that don't have coords yet
		for (const o of orders) {
		  const type = (o.order_type || '').toLowerCase();
		  console.log('[loadAndRender] order', o.id, 'type=', type, 'lat=', o.customer_lat, 'lng=', o.customer_lng);

		  if (
			type === 'delivery' &&
			(o.customer_lat == null || o.customer_lng == null)
		  ) {
			console.log('[loadAndRender] -> calling geocodeOrder for', o.id);
			geocodeOrder(o); // fire-and-forget; function updates DB
		  }
		}



		  // üîπ keep existing new-order detection
		  if (!firstLoadDone) {
			// First load: treat all existing orders as already acknowledged
			if (orders.length) {
			  lastSeenCreatedAt = orders[0].created_at;
			  orders.forEach((o) => acknowledgedOrderIds.add(o.id));
			}
			firstLoadDone = true;
		  } else if (orders.length) {
			const newestTime = new Date(orders[0].created_at);
			const prevTime = lastSeenCreatedAt ? new Date(lastSeenCreatedAt) : null;

			let newOnes = [];
			if (prevTime) {
			  newOnes = orders.filter((o) => new Date(o.created_at) > prevTime);
			}

			// always call, so unacknowledged orders keep triggering alerts
			handleNewOrders(newOnes);

			if (orders.length) {
			  lastSeenCreatedAt = orders[0].created_at;
			}
		  }

		  // üîπ store the full list
		  currentOrders = orders;

		  // üîπ render either today-only or all
		  render(getFilteredOrders());
			syncTodayOnlyCheckbox();

		}


	// Initial load
	loadAndRender();

	/* Poll every 15 seconds
	setInterval(loadAndRender, 15000);*/
	
		// ---------- EXPORT CSV ----------
			function csvEscape(value) {
			  if (value == null) return "";
			  const str = String(value);
			  // Escape double quotes by doubling them
			  const escaped = str.replace(/"/g, '""');
			  // Wrap everything in quotes to be safe with commas/newlines
			  return `"${escaped}"`;
			}

			function buildOrderItemsSummary(order) {
			  const items = order.order_items || [];
			  if (!items.length) return "";
			  return items
				.map((it) => {
				  const qty = it.qty || 1;
				  const name = it.name || "";
				  const mods = (it.modifiers || []).map((m) => m.name).join(", ");
				  const spice =
					it.spice == null
					  ? ""
					  : " " + "üå∂Ô∏è".repeat(Math.max(0, Math.min(3, Number(it.spice))));
				  const modsPart = mods ? ` [Mods: ${mods}]` : "";
				  return `${qty}x ${name}${spice}${modsPart}`;
				})
				.join(" | ");
			}

			function exportOrdersToCSV() {
			  const orders = getFilteredOrders(); // respects Today Only toggle
			  if (!orders || !orders.length) {
				alert("No orders to export.");
				return;
			  }

			  // CSV header row
			  const header = [
				"RTK Ref",
				"Booking Time",
				"Created At",
				"Customer Name",
				"Customer Phone",
				"Customer Email",
				"Order Type",
				"Status",
				"Subtotal",
				"Delivery Fee",
				"Total",
				"Address",
				"Notes",
				"Items"
			  ];

			  const rows = [header];

			  orders.forEach((o) => {
				const c = o.customers || {};
				const rtkRef = o.order_ref || `RTK-${String(o.id).slice(0, 8)}`;
				const bookingTime = fmtDisplayTime(o);
				const createdAt = fmtDate(o.created_at);
				const orderType = (o.order_type || "collection").toUpperCase();
				const status = o.status || "pending";
				const subtotal = Number(o.subtotal || 0).toFixed(2);
				const delivery = Number(o.delivery_fee || 0).toFixed(2);
				const total = sumTotal(o).toFixed(2);
				const address = c.address || "";
				const notes = o.notes || "";
				const itemsSummary = buildOrderItemsSummary(o);

				rows.push([
				  rtkRef,
				  bookingTime,
				  createdAt,
				  c.full_name || "",
				  c.phone || "",
				  c.email || "",
				  orderType,
				  status,
				  subtotal,
				  delivery,
				  total,
				  address,
				  notes,
				  itemsSummary
				]);
			  });

			  // Build CSV text
			  const csvLines = rows.map((row) => row.map(csvEscape).join(","));
			  const csvContent = csvLines.join("\r\n");

			  // Trigger browser download
			  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
			  const url = URL.createObjectURL(blob);
			  const a = document.createElement("a");
			  a.href = url;

			  const now = new Date();
			  const isoDate = now.toISOString().slice(0, 10); // YYYY-MM-DD
			  a.download = `orders-${isoDate}.csv`;

			  document.body.appendChild(a);
			  a.click();
			  document.body.removeChild(a);
			  URL.revokeObjectURL(url);
			}

			// Hook up the Export button
			const exportBtn = document.getElementById("export");
			if (exportBtn) {
			  exportBtn.addEventListener("click", exportOrdersToCSV);
			}




  </script>
<script>
  console.log("Admin actions script loaded");

 // 1) URL of your Supabase Edge Function
const ORDER_ACTION_API_URL =
  "https://ubyjrrsvbbqomitpaidb.supabase.co/functions/v1/hyper-worker";



// 2) Must match ADMIN_SECRET env var in Supabase
	const ADMIN_SECRET = "f18ea1324e4d6e011f5d3f41ccb9767cf9226d0bd2f8a21";


/*async function ca/* -----------------------------------------------------------
   ORDER ACTION API CALLER (existing function ‚Äî unchanged)
----------------------------------------------------------- */
async function callOrderAction(payload) {
  console.log("Calling order-action with payload:", payload);

  try {
    const res = await fetch(ORDER_ACTION_API_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-admin-secret": ADMIN_SECRET
      },
      body: JSON.stringify(payload)
    });

    let data;
    try {
      data = await res.json();
    } catch {
      data = {};
    }

    console.log("order-action response:", res.status, data);

    if (!res.ok) {
      alert("Error: " + (data.error || "Unknown error"));
      return null;
    }

    return data;
  } catch (err) {
    console.error("Network error calling order-action:", err);
    alert("Network error calling order-action");
    return null;
  }
}



/* -----------------------------------------------------------
   notifyCustomer() ‚Äî sends SMS/email via Railway backend
----------------------------------------------------------- */
const NOTIFY_API_BASE = "https://order-backend-production.up.railway.app";

		async function notifyCustomer(mode, row, extra = {}) {
		  if (!row) {
			console.warn("notifyCustomer: missing row");
			return;
		  }

		  const payload = {
			order_id: row.dataset.orderId,                 // <-- no Number()
			order_ref: row.dataset.orderRef,
			name: row.dataset.name,
			email: row.dataset.email,
			phone: row.dataset.phone,
			asap_requested: row.dataset.asapRequested === "true",
			total: Number(row.dataset.total || 0),
			communication_preference: row.dataset.communicationPreference || "email",
			...extra
		  };

		  let url = "";
		  if (mode === "time_confirmed") url = "/notify-time-confirmed";
		  if (mode === "time_suggested") url = "/notify-time-suggested";
		  if (mode === "time_declined")  url = "/notify-time-declined";

		  try {
			const res = await fetch(NOTIFY_API_BASE + url, {
			  method: "POST",
			  headers: { "Content-Type": "text/plain" },
			  body: JSON.stringify(payload)
			});

			console.log(`[notifyCustomer] ${mode}:`, res.status, payload);
		  } catch (err) {
			console.error("notifyCustomer failed:", err);
		  }
		}

		// We are closed Monday (1) and Tuesday (2). All other days are "working".
			function nextWorkingDay(date) {
			  const d = new Date(date);
			  while (true) {
				const day = d.getDay(); // 0=Sun, 1=Mon, 2=Tue, 3=Wed, ...
				if (day !== 1 && day !== 2) {
				  return d; // Wed, Thu, Fri, Sat, Sun
				}
				d.setDate(d.getDate() + 1);
			  }
			}



/* -----------------------------------------------------------
   SINGLE GLOBAL CLICK HANDLER ‚Äî Accept / Decline / Suggest
----------------------------------------------------------- */
document.addEventListener("click", async (event) => {
  const btn = event.target.closest("button");
  if (!btn) return;

  const orderId = btn.dataset.orderId;
  if (!orderId) return;

  const row = btn.closest("tr");

 /* ---------------- ACCEPT ORDER ---------------- */
if (btn.classList.contains("btn-accept")) {
  const result = await callOrderAction({ action: "accept", orderId });

  if (result?.success) {
    // Prefer whatever we already have on the row; fall back to API result
    const preferredTime =
      row.dataset.preferredTime ||
      result.preferred_time ||
      null;

    await notifyCustomer("time_confirmed", row, {
      preferred_time: preferredTime,
      asap_requested: row.dataset.asapRequested === "true"
    });

    alert("Order accepted. Customer notified.");
    location.reload();
  }
  return;
}



  /* ---------------- DECLINE ORDER ---------------- */
  if (btn.classList.contains("btn-decline")) {
    const reason = window.prompt("Reason for declining? (optional):");
    if (reason === null) return; // cancel pressed

    const result = await callOrderAction({
      action: "decline",
      orderId,
      reason: reason.trim()
    });

    if (result?.success) {
      await notifyCustomer("time_declined", row);
      alert("Order declined. Customer notified.");
      location.reload();
    }
    return;
  }


  /* ---------------- SUGGEST NEW TIME ---------------- */
		 if (btn.classList.contains("btn-suggest")) {
		  const row = btn.closest("tr");
		  const input = row ? row.querySelector(".suggest-time-input") : null;
		  const suggestedTime = input ? input.value : ""; // "19:45"

		  if (!suggestedTime) {
			alert("Please choose a time first.");
			return;
		  }

		  const createdAt = row ? row.dataset.createdAt : null;
		  const isAsap = row && row.dataset.asapRequested === "true";

		  let proposedIso;
		  try {
			let base = createdAt ? new Date(createdAt) : new Date();

			if (isAsap) {
			  // For ASAP orders, move to the next working day (we're closed Mon/Tue)
			  base = nextWorkingDay(base);
			}

			const [hh, mm] = suggestedTime.split(":");
			base.setHours(Number(hh) || 0, Number(mm) || 0, 0, 0);
			proposedIso = base.toISOString();
		  } catch (e) {
			console.error("Failed to build proposedTime ISO:", e);
			alert("Could not build the proposed time ‚Äì please try again.");
			return;
		  }

		  const payload = {
			action: "suggest_time",
			orderId,
			proposedTime: proposedIso
		  };
		  console.log("Suggest payload:", payload);

		  const result = await callOrderAction(payload);

		  if (result?.success) {
			// üîî For ASAP orders, send customer SMS directly from admin
			if (isAsap) {
			  await notifyCustomer("time_suggested", row, {
				proposed_time: proposedIso,
				asap_requested: true
			  });
			}

			alert("Suggested time sent to customer.");
			location.reload();
		  }
		  return;
		}




  /* ---------------- MARK PAID ---------------- */
  if (btn.classList.contains("btn-paid")) {
    if (!confirm("Mark this order as paid?")) return;

    const result = await callOrderAction({
      action: "mark_paid",
      orderId
    });

    if (result?.success) {
      alert("Order marked as paid.");
      location.reload();
    }
    return;
  }


  /* ---------------- MARK COMPLETED / COLLECTED ---------------- */
  if (btn.classList.contains("btn-complete")) {
    if (!confirm("Mark this order as completed/collected?")) return;

    const result = await callOrderAction({
      action: "complete",
      orderId
    });

    if (result?.success) {
      alert("Order marked as completed.");
      location.reload();
    }
    return;
  }
});




</script>

</body>
</html>
