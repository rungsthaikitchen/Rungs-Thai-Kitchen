<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RTK ‚Äî Admin Orders</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --accent:#d9464a; --muted:#6b7280; --card:#fff;
      --shadow: 0 8px 24px rgba(15,23,42,0.06);
      font-family: 'Nunito', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    body{margin:0;background:#faf9f8;color:#111}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;z-index:10}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:22px}
    .muted{color:var(--muted)}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{padding:8px 12px;border-radius:8px;border:1px solid #e8e6e6;background:#fff;cursor:pointer;font-weight:700}
    .btn-accent{background:var(--accent);color:#fff;border-color:var(--accent)}
    main .wrap{padding-top:16px}
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    thead th{font-size:13px;color:var(--muted);text-align:left;padding:0 10px}
    tbody tr{background:#fff;box-shadow:var(--shadow)}
    td{padding:12px 10px;vertical-align:top}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #eee;background:#fff}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px}
    .small{font-size:13px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .row{border-radius:12px}
    .expander{cursor:pointer;color:var(--accent);font-weight:700}
    .details{display:none;border-top:1px dashed #eee;margin-top:8px;padding-top:10px}
    .line{display:flex;justify-content:space-between;gap:10px}
    .line small{color:var(--muted)}
    .nowrap{white-space:nowrap}
    .badge{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border:1px solid #eee;border-radius:999px;background:#fff;font-size:12px}
    .allergens{display:flex;gap:6px;flex-wrap:wrap}
  
  /* Everything inside here only affects printing */
  @media print {

    /* General font sizing for print */
    body {
      font-size: 14pt;              /* bump this up or down as you like */
      line-height: 1.4;
    }

    /* Limit content width to suit 80mm paper */
    .order-print-area {
      max-width: 80mm;
    }

    /* Hide anything that shouldn't appear on the printout */
    .no-print,
    .admin-header,
    .sidebar,
    .footer,
    .buttons-row,
    .search-bar {
      display: none !important;
    }

    /* Optional: remove background colours and images */
    * {
      background: transparent !important;
      box-shadow: none !important;
    }

    /* Tidy up links (no underlines / URLs) */
    a {
      text-decoration: none !important;
    }

    /* Make key sections clearer / bigger */
    .order-main-heading {
      font-size: 18pt;
      font-weight: bold;
    }

    .order-items-table {
      font-size: 13pt;
    }

    .order-totals {
      font-size: 14pt;
      font-weight: bold;
    }
  }
  
		  /* New order toast */
		.new-order-toast {
		  position: fixed;
		  top: 16px;
		  right: 16px;
		  background: #16205b;
		  color: #fff;
		  padding: 10px 14px;
		  border-radius: 8px;
		  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
		  font-size: 14px;
		  z-index: 99999;
		  opacity: 0;
		  transform: translateY(-8px);
		  transition: opacity 0.25s ease, transform 0.25s ease;
		}

		.new-order-toast.show {
		  opacity: 1;
		  transform: translateY(0);
		}
		
		.new-order-banner {
		  position: fixed;
		  bottom: 20px;
		  right: 20px;
		  background: #16205b;
		  color: #fff;
		  padding: 10px 14px;
		  border-radius: 10px;
		  box-shadow: 0 4px 12px rgba(0,0,0,0.25);
		  font-size: 14px;
		  display: flex;
		  align-items: center;
		  gap: 10px;
		  z-index: 99999;
		}

		.new-order-banner button {
		  background: #d9464a;
		  color: #fff;
		  border: none;
		  border-radius: 999px;
		  padding: 6px 12px;
		  cursor: pointer;
		  font-size: 13px;
		  font-weight: 600;
		}

		.new-order-banner button:hover {
		  opacity: 0.9;
		}


  
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h1>Rung‚Äôs Thai Kitchen ‚Äî Orders</h1>
        <div class="muted small">Live dashboard (auto-updates)</div>
      </div>
      <div class="controls">
        <button id="refresh" class="btn">Refresh</button>
        <button id="export" class="btn">Export CSV</button>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <table>
        <thead>
          <tr>
			<th>RTK Ref</th>
            <!--<th>Order</th>-->
            <th>Date</th>
            <th>Customer</th>
            <th>Type</th>
            <th class="nowrap">Subtotal</th>
            <th class="nowrap">Delivery</th>
            <th class="nowrap">Total</th>
            <th style="text-align:right">Actions</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <!-- rows injected here -->
        </tbody>
      </table>
      <div id="empty" class="muted" style="margin-top:12px;display:none">No orders yet.</div>
    </div>
  </main>
  <audio id="new-order-sound" src="Sounds/bell railroad1.wav" preload="auto"></audio>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ---------- Config ----------
    const SUPABASE_URL = 'https://ubyjrrsvbbqomitpaidb.supabase.co';
	const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVieWpycnN2YmJxb21pdHBhaWRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5NTYyNjMsImV4cCI6MjA3NjUzMjI2M30.WTllxO5KnaMI0i1d4VHNBhjLuRMfu4_Xx5arqZmYevw';


    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

	// --- AUDIO + NEW-ORDER ALERT STATE ---------------------------------

	let audioUnlocked = false;
	let firstLoadDone = false;
	let lastSeenCreatedAt = null;

	// Orders we still haven't acknowledged this session
	const unacknowledgedOrders = new Map();   // id -> order
	const acknowledgedOrderIds = new Set();   // ids we've already acknowledged

	// Unlock audio on first user interaction (for autoplay policies)
	function unlockAudioOnce() {
	  const audio = document.getElementById('new-order-sound');
	  if (!audio || audioUnlocked) return;

	  audio.play().then(() => {
		audio.pause();
		audio.currentTime = 0;
		audioUnlocked = true;
		document.removeEventListener('click', unlockAudioOnce);
		document.removeEventListener('keydown', unlockAudioOnce);
		console.info('New-order sound unlocked');
	  }).catch(err => {
		console.warn('Audio unlock failed:', err);
	  });
	}

	document.addEventListener('click', unlockAudioOnce);
	document.addEventListener('keydown', unlockAudioOnce);

	// Show a banner with Acknowledge button when there are unacknowledged orders
	function showNewOrderBanner() {
	  const count = unacknowledgedOrders.size;
	  if (!count) return;

	  let banner = document.getElementById('new-order-banner');
	  if (!banner) {
		banner = document.createElement('div');
		banner.id = 'new-order-banner';
		banner.className = 'new-order-banner';
		document.body.appendChild(banner);
	  }

	  const text = count === 1
		? '1 new order awaiting acknowledgement'
		: `${count} new orders awaiting acknowledgement`;

	  banner.innerHTML = `
		<span>üîî ${text}</span>
		<button type="button" id="ack-new-orders-btn">Acknowledge</button>
	  `;

	  const btn = document.getElementById('ack-new-orders-btn');
	  if (btn) {
		btn.onclick = acknowledgeNewOrders;
	  }
	}

	function acknowledgeNewOrders() {
	  // Mark all as acknowledged for this session
	  unacknowledgedOrders.forEach((order) => {
		acknowledgedOrderIds.add(order.id);
	  });
	  unacknowledgedOrders.clear();

	  const banner = document.getElementById('new-order-banner');
	  if (banner) banner.remove();
	}

	// Handle brand new orders + repeat alerts for unacknowledged ones
	function handleNewOrders(newOrders) {
	  // 1) Add any *brand new* orders into the unacknowledged set
	  (newOrders || []).forEach(o => {
		if (!acknowledgedOrderIds.has(o.id)) {
		  unacknowledgedOrders.set(o.id, o);
		}
	  });

	  // 2) If there are NO unacknowledged orders, nothing to do
	  if (unacknowledgedOrders.size === 0) return;

	  // 3) Play sound (if unlocked)
	  const audio = document.getElementById('new-order-sound');
	  if (audio && audioUnlocked) {
		audio.play().catch(err => {
		  console.warn('New-order sound play failed:', err);
		});
	  }

	  // 4) Show / update banner
	  showNewOrderBanner();
	}
	
	function sumTotal(order) {
  // Safely sum subtotal + delivery fee
  const subtotal = Number(order.subtotal || 0);
  const delivery = Number(order.delivery_fee || 0);
  return subtotal + delivery;
}

function fmtDate(value) {
  if (!value) return '‚Äî';
  try {
    return new Date(value).toLocaleString('en-GB', {
      dateStyle: 'short',
      timeStyle: 'short'
    });
  } catch (e) {
    console.warn('Bad date value:', value, e);
    return String(value);
  }
}

function fmtMoney(value) {
  const num = Number(value || 0);
  try {
    return new Intl.NumberFormat('en-GB', {
      style: 'currency',
      currency: 'GBP',
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    }).format(num);
  } catch (e) {
    console.warn('Bad money value:', value, e);
    return `¬£${num.toFixed(2)}`;
  }
}

function buildDetailsHTML(o){
  const c = o.customers || {};

  // RTK ref: use order_ref if present, else fallback to short UUID
  const rtkRef = o.order_ref || `RTK-${String(o.id).slice(0, 8)}`;

  const lines = (o.order_items || []).map(item => {
    const mods = (item.modifiers || []).map(m => m.name).join(', ');
    const spice = (item.spice == null)
      ? ''
      : (' '.repeat(1) + 'üå∂Ô∏è'.repeat(Math.max(0, Math.min(3, Number(item.spice)))));
    const modsFrag = mods ? `<div class="small muted">Mods: ${mods}</div>` : '';
    const img = item.img
      ? `<img src="${item.img}" alt="${item.name}" style="width:60px;height:60px;object-fit:cover;border-radius:8px;border:1px solid #eee;margin-right:8px">`
      : '';

    return `
      <div class="line">
        <div style="display:flex;align-items:center;gap:8px">
          ${img}
          <div>
            <div><strong>${item.name}</strong> √ó ${item.qty}${spice}</div>
            ${modsFrag}
          </div>
        </div>
        <div><strong>${fmtMoney(Number(item.unit_price) * Number(item.qty))}</strong></div>
      </div>
    `;
  }).join('');

  const addr = [c.address].filter(Boolean).join('<br>');

  return `
    <div class="grid" style="margin-bottom:8px">
      <div>
        <div class="muted small">Customer</div>
        <div><strong>${c.full_name || '‚Äî'}</strong></div>
        <div class="small">${c.phone || ''}</div>
        <div class="small">${c.email || ''}</div>
      </div>
      <div>
        <div class="muted small">Address</div>
        <div class="small">${addr || '‚Äî'}</div>
      </div>
      <div>
        <div class="muted small">Order</div>
        <div class="small"><strong>RTK Ref:</strong> ${rtkRef}</div>
        <div class="small">Type: <strong>${(o.order_type || 'collection').toUpperCase()}</strong></div>
        <div class="small">Subtotal: ${fmtMoney(o.subtotal)}</div>
        <div class="small">Delivery: ${fmtMoney(o.delivery_fee)}</div>
        <div class="small"><strong>Total: ${fmtMoney(sumTotal(o))}</strong></div>
      </div>
    </div>
    <div class="muted small">Notes: ${o.notes ? o.notes : '‚Äî'}</div>
    <div style="margin-top:10px;border-top:1px dashed #eee;padding-top:10px">
      ${lines || '<div class="muted small">No items.</div>'}
    </div>
  `;
}


	
// ---------- Render ----------
const tbody = document.getElementById('tbody');
const empty = document.getElementById('empty');

function render(orders){
  tbody.innerHTML = '';

  if (!orders.length) {
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  orders.forEach(o => {
    const tr = document.createElement('tr');
    tr.className = 'row';

    const customer = o.customers || {};
    const total = sumTotal(o);

    // RTK ref for this order
    const rtkRef = o.order_ref || `RTK-${String(o.id).slice(0, 8)}`;

    tr.innerHTML = `
      <td class="mono">${rtkRef}</td>
      <td class="mono">#${o.id}</td>
      <td>${fmtDate(o.created_at)}</td>
      <td>
        <div><strong>${customer.full_name || '‚Äî'}</strong></div>
        <div class="small muted">${customer.phone || ''}</div>
      </td>
      <td><span class="pill">${(o.order_type || 'collection').toUpperCase()}</span></td>
      <td class="nowrap">${fmtMoney(o.subtotal)}</td>
      <td class="nowrap">${fmtMoney(o.delivery_fee)}</td>
      <td class="nowrap"><strong>${fmtMoney(total)}</strong></td>
      <td class="actions">
        <button class="btn" data-action="toggle">Details</button>
        <button class="btn" data-action="print">Print ticket</button>
      </td>
    `;

    // --- details row (needs its own <tr> and <td>) ---
    const details = document.createElement('div');
    details.className = 'details';
    details.innerHTML = buildDetailsHTML(o);

    const detailsRow = document.createElement('tr');
    const detailsCell = document.createElement('td');
    detailsCell.colSpan = 9;              // 9 columns in main row
    detailsCell.appendChild(details);
    detailsRow.appendChild(detailsCell);

    // --- actions on the main row buttons ---
    tr.querySelector('[data-action="toggle"]').addEventListener('click', () => {
      details.style.display = (details.style.display === 'block') ? 'none' : 'block';
    });

    tr.querySelector('[data-action="print"]').addEventListener('click', () => {
      printTicket(o);
    });

    // append both the main row and the details row
    tbody.appendChild(tr);
    tbody.appendChild(detailsRow);
  });
}



	// --- LOAD + RENDER WITH NEW-ORDER DETECTION ------------------------

	async function loadAndRender() {
	  const { data: orders, error } = await supabase
		.from('orders')
		.select(`
		  id,
		  order_ref,
		  created_at,
		  order_type,
		  subtotal,
		  delivery_fee,
		  notes,
		  customers (
			full_name,
			phone,
			email,
			address
		  ),
		  order_items (
			*
		  )
		`)
		.order('created_at', { ascending: false });

	  if (error) {
		console.error('Error loading orders', error);
		return;
	  }
	  if (!orders) return;

	  if (!firstLoadDone) {
		// First load: treat all existing orders as already acknowledged
		if (orders.length) {
		  lastSeenCreatedAt = orders[0].created_at;
		  orders.forEach(o => acknowledgedOrderIds.add(o.id));
		}
		firstLoadDone = true;
	  } else if (orders.length) {
		const newestTime = new Date(orders[0].created_at);
		const prevTime = lastSeenCreatedAt ? new Date(lastSeenCreatedAt) : null;

		let newOnes = [];
		if (prevTime) {
		  newOnes = orders.filter(o => new Date(o.created_at) > prevTime);
		}

		// Always call, so unacknowledged orders keep triggering alerts
		handleNewOrders(newOnes);

		if (orders.length) {
		  lastSeenCreatedAt = orders[0].created_at;
		}
	  }

	  // Your existing render function
	  render(orders);
	}

	// Initial load
	loadAndRender();

	// Poll every 15 seconds
	setInterval(loadAndRender, 15000);


  </script>

</body>
</html>
