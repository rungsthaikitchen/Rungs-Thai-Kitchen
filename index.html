<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rung's Thai Kitchen</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100..900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Outfit:wght@100..900&display=swap" rel="stylesheet">
  <style>
    :root{
      --accent:#d9464a;
      --accent-dark:#b02a2a;
      --muted:#6b7280;
      --card:#fff;
      --shadow: 0 8px 24px rgba(15,23,42,0.06);
	  --crimson:#CC0C1A;
      font-family: 'Nunito', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#fff 0%,#fff8f6 100%);color:#111;}
    .container{max-width:1100px;margin:0 auto;padding:20px;}

    /* Header */
    /* Header */
.site-header {
  background: var(--card);
  box-shadow: var(--shadow);
  border-radius: 12px;
  margin-bottom: 20px;
  padding: 14px 20px 16px;
  position: sticky;
  top: 12px;
  z-index: 1100;
}

.header-inner.centered {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 14px;
  text-align: center;
}

.brand-block {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}

.brand-logo {
  height: 120px;
  width: auto;
  display: block;
}

.brand-title {
  color: var(--crimson);
  font-weight: 800;
  font-size: 1.3rem;
}

.brand-tagline {
  color: var(--muted);
  font-size: 0.9rem;
  letter-spacing: 0.04em;
}

/* Nav */
.main-nav ul {
  display: flex;
  gap: 4px;
  list-style: none;
  padding: 0;
  margin: 0;
  flex-wrap: wrap;
  justify-content: center;
}

.main-nav a {
  color: #111;
  text-decoration: none;
  font-weight: 700;
  font-size: 0.9rem;
  padding: 4px 8px;
  border-radius: 999px;
}

.main-nav a:hover {
  background: rgba(217, 70, 74, 0.1);
}

/* mobile tweaks */
@media (max-width: 640px) {
  .brand-logo {
    height: 90px;
  }
  .main-nav ul {
    gap: 10px;
  }
  .main-nav a {
    font-size: 0.85rem;
  }
}

    .logo{display:flex;align-items:center;gap:10px}
    .logo img {height: 125px; width: auto;}
    nav ul{display:flex;gap:16px;list-style:none;margin:0;padding:0}
    nav a{color:#111;text-decoration:none;font-weight:700;font-size:14px}

    /* Layout */
    main{display:grid;grid-template-columns:1fr 360px;gap:18px}
    .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:var(--shadow)}
    h1,h2,h3{margin:0}
    h1{font-size:20px}
    .muted{color:var(--muted)}
    .small{font-size:13px}
    .price{font-weight:800}
    .btn{display:inline-block;padding:8px 12px;border-radius:8px;text-decoration:none;font-weight:700;cursor:pointer;font-size:13px}
    .btn-accent{background:var(--accent);color:white;border:none}
    .btn-ghost{background:transparent;border:1px solid #eee}
    .btn[disabled]{opacity:.55;cursor:not-allowed;filter:grayscale(10%)}
	
	/* body { background: #16205B; } */
/* #menu h2::after { ... } */


		header {
	  background: rgba(255,255,255);
	  backdrop-filter: blur(8px);
	}

	.menu-item {
	  background: rgba(255,255,255,0.85);
	  transition: transform .12s ease, box-shadow .12s ease;
	}
	.menu-item:hover {
	  transform: translateY(-2px);
	  box-shadow: 0 4px 16px rgba(217,70,74,0.08);
	}

	.btn-accent {
	  background: linear-gradient(135deg, #d9464a 0%, #b02a2a 100%);
	  box-shadow: 0 6px 16px rgba(217,70,74,0.35);
	}

	#menu h2 {
	  display:flex;
	  align-items:center;
	  gap:6px;
	}
	/* body { background: #16205B; } */
/* #menu h2::after { ... } */



    /* Menu categories (accordion) */
    .menu-section{display:grid;gap:12px}
    .category{border-radius:10px;border:1px solid #f3e7e6;overflow:hidden}
    .category-header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;background:#fff4f3;cursor:pointer}
    .category-header h3{margin:0;font-size:16px}
    .category-body{
      max-height:0; overflow:hidden;
      transition:max-height .28s ease, padding .28s ease;
      padding:0 12px;
    }
    .category-body.open{ padding:12px; }
    .menu-item{display:flex;justify-content:space-between;align-items:flex-start;padding:10px;border-radius:8px;border:1px solid #f7efee;margin-bottom:8px}
    .menu-item .meta{max-width:72%}
    .menu-item .meta .title{font-weight:700}

    /* Order */
    aside { align-self: start; }
    #order-panel{ position: sticky; top: 20px; z-index: 1000; width: 100%; }
    .order-list{display:flex;flex-direction:column;gap:10px}
    .order-row{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;border:1px dashed #f0e6e5;gap:10px}
    .item-thumb{width:54px;height:54px;object-fit:cover;border-radius:8px;border:1px solid #eee;background:#f8f8f8}

    /* Our Food gallery */
    .food-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .food-grid img{width:100%;height:140px;object-fit:cover;border-radius:8px;box-shadow:0 6px 16px rgba(15,23,42,0.06);cursor:pointer}
    .food-grid img:hover{transform:translateY(-4px);transition:transform .18s ease,box-shadow .18s ease}

    /* Modal (customise & checkout & success) */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;padding:18px;z-index:1200; overflow:auto; -webkit-overflow-scrolling:touch}
    .modal{width:100%;max-width:720px;background:var(--card);border-radius:12px;padding:16px;box-shadow:0 12px 40px rgba(0,0,0,0.25); max-height:90vh; overflow:auto}
    .mods{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .chip{padding:8px 10px;border-radius:999px;border:1px solid #eee;cursor:pointer;font-size:13px;background:#fff; min-height:44px; touch-action:manipulation}
    .chip.selected{background:#fff4f3;border-color:var(--accent)}
    input[type=number]{width:72px;padding:8px;border-radius:8px;border:1px solid #e7e3e3}
    .qty-controls{display:flex;align-items:center;gap:8px}
    .totals{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
    .mod-required-note{margin-top:8px;font-size:13px;color:#b02a2a;display:none}
    .mod-limit-note{margin-top:6px;font-size:12px;color:var(--muted);display:none}

    /* Spice selector */
    .spice-wrap{margin-top:12px}
    .spice-label{font-size:13px;color:var(--muted)}
    .spice-buttons{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap}
    .spice-btn{border:1px solid #eee;background:#fff;border-radius:999px;padding:6px 10px;font-size:13px;cursor:pointer; min-height:44px; touch-action:manipulation}
    .spice-btn.active{border-color:var(--accent);background:#fff4f3}

    /* Allergens */
    .allergen-icon{font-size:14px;margin-right:6px}
    .allergen-badges{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
    .allergen-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid #eee;border-radius:999px;background:#fff;font-size:12px}

    footer{margin-top:18px;text-align:center;padding:18px;border-radius:10px;background:rgba(204,12,26,0.35);color:white; padding-bottom:max(18px, env(safe-area-inset-bottom));}

    /* Checkout form layout/styling */
    #checkout-form > div { margin-top: 10px; }
    .form-grid { display:grid; gap:12px; }
    .form-grid .row-2 { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width:560px){ .form-grid .row-2 { grid-template-columns:1fr; } }
    .field { display:flex; flex-direction:column; gap:6px; }
    .field label { font-size:13px; color:var(--muted); }
    .input, .textarea, .select {
      font: inherit;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #e7e3e3;
      background:#fff;
      outline: none;
      box-shadow: none;
    }
    .input:focus, .textarea:focus, .select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(217,70,74,.12);
    }
    .input.auto-fit { width:auto; max-width:100%; min-width:18ch; white-space:nowrap; }
    .input-measure { position:absolute; visibility:hidden; white-space:pre; font:inherit; padding:10px 12px; border:1px solid transparent; }
	/* ===== mobile / small screens ===== */
@media (max-width: 900px) {
  /* header: stack logo above nav, but keep nav links horizontal */
  header {
    position: static;
  }
  .header-inner {
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: 8px;
  }

  /* nav: horizontal list that wraps nicely */
  nav ul {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px 14px;
    padding: 0;
    margin: 0;
    list-style: none;
  }

  nav ul li {
    display: inline-block;
  }

  nav a {
    font-size: 0.95rem;
    padding: 4px 8px;
  }

  /* main layout: single column, order summary below menu */
  main {
    display: block;
  }

  #order-panel {
    position: static;
    width: 100%;
    margin-top: 20px;
  }

	  #order-success .order-line {
	  display:flex;
	  justify-content:space-between;
	  gap:12px;
	  align-items:flex-start;
	}
		#order-success .order-line-left {
		  display:flex;
		  flex-wrap:wrap;
		  gap:4px;
		  align-items:cente
		}
		#order-success .spice {
		  display:inline-block;
		  min-width:3.2rem; /* keeps üå∂Ô∏è from jumping */
		}


  /* menu items: full width on mobile */
  .menu-item {
    flex-direction: column;
    gap: 8px;
  }
}
/* === Parallax background layer === */
.bg-parallax {
  position: fixed;
  inset: 0;
  z-index: -1;
  pointer-events: none;
  overflow: hidden;
  background:
    /* top image */
    url("./images/bg-top6.JPG?v=2") center top / cover no-repeat,
    /* bottom image */
    url("images/bg-bottom.jpg") center 120vh / cover no-repeat,
    /* fallback colour under both */
    #0b1120;
  background-attachment: fixed, fixed, scroll;
  /* dim it a bit so text stays readable */
  filter: brightness(.55);
}

/* extra spacing between sections so we *see* the background */
.card {
  margin-bottom: 175px;   /* was 14‚Äì18px in places */
}

/* give main a bit more vertical rhythm */
main > section > .card + .card {
  margin-top: 250px;
}

/* keep footer off the bottom a little so background shows */
footer {
  margin-top: 30px;
}

/* mobile fallback: iOS hates background-attachment:fixed */
@media (max-width: 768px) {
  .bg-parallax {
    background-attachment: scroll, scroll, scroll;
    background-size: cover, cover, auto;
  }
}
.card {
  background: rgba(255,255,255,0.9);
  backdrop-filter: blur(2px);
}

/* This helps anchors or programmatic scrolls land below the sticky header */
:root {
  /* Fallback; JS updates this dynamically */
  --header-offset: 96px;
}

/* Browser will keep this much space at top when scrolling to anything */
html {
  scroll-padding-top: var(--header-offset);
  scroll-behavior: smooth; /* optional */
}

/* Any of these elements will land below the sticky header when scrolled to */
.category,
.category-header,
.category-body {
  scroll-margin-top: var(--header-offset);
}

.category { scroll-margin-top: 72px; } /* adjust if your header is taller on mobile */




<script>
console.info('Console levels forced');
console.log = console.info = console.debug = console.warn = console.error = console.log.bind(console);
</script>


  </style>
</head>
<body>
<body>
  <div class="bg-parallax" aria-hidden="true"></div>
  <div class="container">
    <!-- your existing header / main / etc -->

  <div class="container">
    <!-- Header -->
    <header class="site-header">
  <div class="header-inner centered">
    <div class="brand-block">
      <img src="images/RTKWhite1.png" alt="Rung's Thai Kitchen Logo" class="brand-logo">
      <!--<div class="brand-title">Rung's Thai Kitchen</div>-->
      <div class="brand-title">Authentic Thai Takeaway</div>
    </div>

    <nav class="main-nav">
      <ul>
        <li><a href="#about">About</a></li>
        <li><a href="#our-food">Our Food</a></li>
        <li><a href="#allergens">Allergens</a></li>
        <li><a href="#menu">Menu</a></li>
        <!--<li><a href="#order">Order</a></li>-->
        <li><a href="#contact">Contact</a></li>
      </ul>
    </nav>
  </div>
</header>


    <main>
      <!-- Left column -->
      <section>
        <!-- About -->
        <div class="card" id="about" style="margin-top:8px">
          <h2>About Rung's Thai Kitchen</h2>
          <p class="muted">
            Welcome to Rung's Thai Kitchen, where I take pride in delivering authentic Thai takeaway food right to your doorstep in Leeds.</p>
			<p class="muted"> My culinary journey began with a passion for traditional Thai recipes handed down through generations. I believe that the secret to great Thai cuisine lies in using fresh, high-quality ingredients and a careful balance of flavours. Each dish is crafted with love and dedication, ensuring that you experience the vibrant and aromatic taste of Thailand in every bite.</p>
			<p class="muted">Whether you're craving a comforting curry or a refreshing salad, I've got you covered.
          </p>
        </div>

        <!-- Our Food -->
        <div class="card" id="our-food" style="margin-top:8px">
          <h2>Our Food</h2>
          <div style="display:flex;gap:18px;align-items:flex-start;flex-wrap:wrap">
            <div style="flex:1 1 320px;min-width:240px">
              <p class="muted">
                At Rung's Thai Kitchen we use fresh, locally sourced ingredients and traditional Thai techniques.
                Our dishes are prepared to order ‚Äî bold flavours, balanced spice, and a focus on bright, fresh herbs.
              </p>
              <p class="muted" style="margin-top:8px">
                If you have dietary requirements please mention them when placing your order. We adapt where we can.
              </p>
            </div>
            <div style="flex:1 1 360px;min-width:260px">
              <div class="food-grid" id="food-grid">
                <img src="images/SpringRoll.jpg" alt="Spring Rolls" loading="lazy" />
                <img src="images/Prawns.jpg" alt="Deep Fried Tiger Prawns" loading="lazy" />
                <img src="images/TomYum.jpg" alt="Tom Yum" loading="lazy" />
                <img src="images/thaifishcakesjpg.jpg" alt="Thai Fish Cakes" loading="lazy" />
                <img src="images/somtam.jpg" alt="Papaya salad" loading="lazy" />
                <img src="images/PrawnCrackers.jpg" alt="Prawn Crackers" loading="lazy" />
              </div>
            </div>
          </div>
        </div>

        <!-- Allergens -->
        <div class="card" id="allergens" style="margin-top:14px">
          <h2 style="margin-bottom:10px">Allergens & Ingredients</h2>
          <p class="muted">
            We take food allergies seriously. Many of our dishes can be prepared without certain allergens ‚Äî please
            mention any allergies when placing your order. The icons below indicate dishes that contain:
          </p>
          <div style="margin-top:10px;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;line-height:1.5">
            <div><span class="allergen-icon">ü•ú</span> Peanuts</div>
            <div><span class="allergen-icon">üå∞</span> Tree Nuts</div>
            <div><span class="allergen-icon">üåæ</span> Gluten (Cereals)</div>
            <div><span class="allergen-icon">ü¶ê</span> Crustaceans (Shellfish)</div>
            <div><span class="allergen-icon">ü¶™</span> Molluscs (e.g. squid, mussels)</div>
            <div><span class="allergen-icon">ü•õ</span> Milk / Dairy</div>
            <div><span class="allergen-icon">üç≥</span> Egg</div>
            <div><span class="allergen-icon">üêü</span> Fish</div>
            <div><span class="allergen-icon">üåø</span> Celery</div>
            <div><span class="allergen-icon">üåº</span> Lupin</div>
            <div><span class="allergen-icon">&#x1F331;</span> Mustard</div>
            <div><span class="allergen-icon">‚ö´</span> Sesame Seeds</div>
            <div><span class="allergen-icon">ü´ò</span> Soya</div>
            <div><span class="allergen-icon">üí®</span> Sulphur Dioxide / Sulphites</div>
            <div><span class="allergen-icon">üå∂Ô∏è</span> Spice Level (heat indicator)</div>
          </div>
        </div>

        <!-- Menu -->
        <div class="card" id="menu" style="margin-top:14px">
          <h2 style="margin-bottom:10px">Menu</h2>
          <div class="menu-section" id="menu-list"><!-- built by JS --></div>
        </div>
      </section>

      <!-- Right column: Order -->
      <aside>
        <div class="card" id="order-panel">
          <h2>Your Order</h2>
          <div id="order-list" class="order-list" style="margin-top:12px">
            <div class="muted small">No items yet ‚Äî add something from the menu.</div>
          </div>
          <div class="totals" style="margin-top:14px">
            <div class="muted small">Total</div>
            <div id="order-total" style="font-weight:800">¬£0.00</div>
          </div>
          <button id="open-checkout" type="button" class="btn btn-accent" style="width:100%;margin-top:12px">Proceed to Checkout</button>
          <div id="order-msg" class="muted small" style="margin-top:8px"></div>
        </div>
      </aside>
    </main>

    <!-- Footer -->
    <footer id="contact">
      <div style="max-width:700px;margin:0 auto">
        <div style="font-weight:800">Contact Us</div>
        <div class="muted" style="margin-top:6px">Phone: 0113 3447431 &nbsp; ‚Ä¢ &nbsp; Email: hello@rungsthaikitchen.co.uk</div>
        <div style="margin-top:10px;font-weight:700">Opening Hours</div>
        <div class="muted">Wed‚ÄìSun: 17:00 ‚Äì 21:00</div>
      </div>
    </footer>
  </div>

  <!-- customise Modal -->
  <div id="modal" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div id="modal-title" style="font-weight:800">customise</div>
          <div id="modal-base" class="muted small" style="margin-top:4px" data-price="0">Base price: ¬£0.00</div>
        </div>
        <button id="modal-close" class="btn btn-ghost">Close</button>
      </div>

      <img id="modal-img" alt="" style="margin-top:10px;width:100%;max-height:220px;object-fit:cover;border-radius:10px;display:none">

      <div style="display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px">
        <div>
          <label class="small">Quantity</label>
          <div class="qty-controls" style="margin-top:6px">
            <button id="qty-decr" class="btn btn-ghost">-</button>
            <input id="qty-input" type="number" min="1" value="1" />
            <button id="qty-incr" class="btn btn-ghost">+</button>
          </div>
        </div>
      </div>

      <div style="margin-top:12px">
        <div class="small">Modifiers (protein / extras)</div>
        <div id="mods" class="mods"></div>
        <div id="mod-required-note" class="mod-required-note">Please choose at least one option to continue.</div>
        <div id="mod-limit-note" class="mod-limit-note"></div>
      </div>

      <div id="modal-allergens-wrap" style="margin-top:10px;display:none">
        <div class="small">Allergens in this dish</div>
        <div id="modal-allergens" class="allergen-badges"></div>
      </div>

      <div id="spice-wrap" class="spice-wrap" style="display:none">
        <div class="spice-label">Spice level</div>
        <div id="spice-buttons" class="spice-buttons"></div>
      </div>

      <div class="totals" style="margin-top:12px">
        <div class="muted small">Unit price</div>
        <div id="unit-price" style="font-weight:800">¬£0.00</div>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:14px">
        <button id="modal-cancel" class="btn btn-ghost">Cancel</button>
        <button id="modal-add" class="btn btn-accent">Add to basket</button>
      </div>
    </div>
  </div>

  <!-- Checkout Modal -->
  <div id="checkout-modal" class="modal-backdrop" style="display:none" aria-modal="true" role="dialog">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:800">Customer details</div>
          <div class="muted small" style="margin-top:4px">We‚Äôll save with your order.</div>
        </div>
        <button id="checkout-close" class="btn btn-ghost">Close</button>
      </div>

      <form id="checkout-form" class="form-grid">
        <div class="field">
          <label for="cust-name">Full name</label>
          <input id="cust-name" name="name" type="text" autocomplete="name" required class="input auto-fit">
        </div>

        <div class="row-2">
          <div class="field">
            <label for="cust-email">Email</label>
            <input id="cust-email" name="email" type="email" inputmode="email" autocomplete="email" class="input auto-fit">
          </div>
          <div class="field">
            <label for="cust-phone">Phone</label>
            <input id="cust-phone" name="phone" type="tel" inputmode="tel" autocomplete="tel" required class="input auto-fit">
          </div>
        </div>

        <div class="field">
          <label for="cust-address">Address (flat/house number, street name & post code please)</label>
          <input id="cust-address" name="address" type="text" autocomplete="street-address"
                 inputmode="text" class="input auto-fit" placeholder="House no., street, town, postcode">
        </div>

        <div class="field">
          <label>Order type</label>
          <div style="display:flex;gap:12px;align-items:center">
            <label><input type="radio" name="order-type" id="order-type-collection" value="collection" checked> Collection</label>
            <label><input type="radio" name="order-type" id="order-type-delivery" value="delivery"> Delivery</label>
          </div>
          <div id="delivery-note" class="muted small" style="margin-top:4px;display:none">
            Delivery is ¬£3 for orders under ¬£20, free for ¬£20 and above.
          </div>
        </div>

        <!-- Preferred time -->
        <div class="field">
          <label for="cust-preferred-time">Preferred collection/delivery time</label>
          <input id="cust-preferred-time" name="preferred_time" type="datetime-local" class="input">
          <div class="muted small">We‚Äôll do our best to meet this time. We‚Äôll contact you to confirm.</div>
        </div>

        <div class="field">
          <label for="cust-notes">Notes (optional)</label>
          <input id="cust-notes" name="notes" type="text" class="input auto-fit"
                 placeholder="Allergies, delivery instructions, etc.">
        </div>

        <div class="totals">
          <div class="muted small">Subtotal</div>
          <div id="checkout-subtotal" style="font-weight:800">¬£0.00</div>
        </div>
        <div class="totals">
          <div class="muted small">Delivery Fee</div>
          <div id="checkout-delivery" style="font-weight:800">¬£0.00</div>
        </div>
        <div class="totals">
          <div class="muted small">Total</div>
          <div id="checkout-total" style="font-weight:800">¬£0.00</div>
        </div>

        <div class="checkout-actions" style="display:flex;justify-content:flex-end;gap:8px;margin-top:4px;position:sticky;bottom:0;background:#fff;padding-top:8px">
          <button type="button" id="checkout-cancel" class="btn btn-ghost">Cancel</button>
          <button type="submit" id="checkout-submit" class="btn btn-accent">Place order</button>
        </div>
        <div id="checkout-msg" class="muted small" style="margin-top:6px"></div>
      </form>
    </div>
  </div>

  <!-- Order Success Modal -->
<div id="order-success" class="modal-backdrop" style="display:none" role="dialog" aria-modal="true">
  <div class="modal" style="max-width:560px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <h3 id="order-success-title" style="margin:0">Order placed</h3>
      <button id="order-success-x" class="btn btn-ghost" type="button">√ó</button>
    </div>

    <div id="order-success-msg" class="muted small" style="margin-bottom:10px"></div>

    <div id="order-success-items" class="small"
         style="max-height:260px;overflow:auto;border:1px solid #eee;
                border-radius:8px;padding:8px;margin-bottom:10px">
    </div>

    <div class="totals">
      <div class="muted small">Total</div>
      <div id="order-success-total" style="font-weight:800">¬£0.00</div>
    </div>

    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
	  <button id="order-success-pdf" class="btn btn-ghost" type="button">Download receipt</button>
	  <button id="order-success-close" class="btn btn-accent" type="button">OK</button>
	</div>

  </div>
</div>


  <script>
	document.addEventListener('DOMContentLoaded', () => {
  // ---------- Allergen registry ----------
  const ALLERGENS = {

      peanuts:   { icon:'ü•ú',        label:'Peanuts' },
      tree_nuts: { icon:'üå∞',        label:'Tree Nuts' },
      gluten:    { icon:'üåæ',        label:'Gluten (Cereals)' },
      shellfish: { icon:'ü¶ê',        label:'Crustaceans (Shellfish)' },
      molluscs:  { icon:'ü¶™',        label:'Molluscs' },
      dairy:     { icon:'ü•õ',        label:'Milk / Dairy' },
      egg:       { icon:'üç≥',        label:'Egg' },
      fish:      { icon:'üêü',        label:'Fish' },
      celery:    { icon:'üåø',        label:'Celery' },
      lupin:     { icon:'üåº',        label:'Lupin' },
      mustard:   { icon:'&#x1F331;', label:'Mustard' },
      sesame:    { icon:'‚ö´',        label:'Sesame Seeds' },
      soya:      { icon:'ü´ò',        label:'Soya' },
      sulphites: { icon:'üí®',        label:'Sulphur Dioxide / Sulphites' },
      spicy:     { icon:'üå∂Ô∏è',       label:'Spicy (heat)' }
    };
    function normalizeAllergens(list){
      const out = [];
      (list || []).forEach(k => { if (k === 'nuts') out.push('peanuts','tree_nuts'); else out.push(k); });
      return [...new Set(out)];
    }
    function renderAllergenIconsCompact(list){
      const normalized = normalizeAllergens(list);
      if(!normalized.length) return '';
      const spans = normalized.map(key => {
        const a = ALLERGENS[key]; if(!a) return '';
        return `<span class="allergen-icon" title="${a.label}" aria-label="${a.label}">${a.icon}</span>`;
      }).join(' ');
      return `<div class="muted small">${spans}</div>`;
    }
    function renderAllergenBadges(list){
      const normalized = normalizeAllergens(list);
      if(!normalized.length) return '';
      return normalized.map(key => {
        const a = ALLERGENS[key]; if(!a) return '';
        return `<span class="allergen-badge" title="${a.label}" aria-label="${a.label}">
                 <span class="allergen-icon">${a.icon}</span><span>${a.label}</span>
               </span>`;
      }).join('');
    }

    // ---------- Data ----------
    const MENU_CATEGORIES = [
      { id: 'starters', title: 'Starter', items: [
        { id: 'veg-spring-rolls', name: 'Vegetable Spring Rolls (x4)', desc: 'Crispy, deep-fried rolls filled with a savoury mixture of glass noodles and vegetables, served with a sweet chilli sauce.', price: 4.50, allergens: ['gluten'] },
        { id: 'chicken-satay', name: 'Chicken Satay', desc: 'Marinated chicken skewers with peanut sauce.', price: 5.00, allergens: ['peanuts','soya','sesame'] },
        { id: 'prawn-crackers', name: 'Prawn Crackers', desc: 'Light, crunchy snacks with sweet chilli sauce.', price: 2.50, allergens: ['shellfish','gluten'] },
        { id: 'moo-ping', name: 'Pork Skewer (Moo Ping)', desc: 'Sweet & savoury grilled pork skewers.', price: 5.00, allergens: [] },
        { id: 'chicken-spring-rolls', name: 'Chicken Spring Rolls (x4)', desc: 'Crispy, deep-fried rolls filled with a savoury mixture of meat, glass noodles, and vegetables, served with a sweet chilli sauce.', price: 5.00, allergens: ['gluten'] },
        { id: 'fried-tofu', name: 'Deep Fried Tofu', desc: 'Crispy Thai Fried Tofu with a sweet-spicy Thai peanut sauce!', price: 3.50, allergens: ['soya','peanuts','sesame'] },
        { id: 'fish-cakes', name: 'Thai Fish Cakes', desc: 'Flavourful, bite-sized fritters with a blend of savoury, spicy, and tangy flavours.', price: 5.00, spiceEnabled: true, spiceDefault: 1, allergens: ['fish','egg','soya'] },
        { id: 'porkprawn-dumplings', name: 'Pork & Prawn Steamed Dumplings', desc: ' Steamed dumplings filled with a savoury combination of tender pork and juicy prawns.', price: 4.50, allergens: ['gluten','shellfish'] },
        { id: 'fried-prawns', name: 'Deep Fried Tiger Prawns (x4)', desc: 'Tiger Prawns cooked in a crispy tempura batter served with Authentic Thai sweet Chilli Sauce.', price: 6.00, allergens: ['shellfish','gluten','egg'] },
        { id: 'thai-sausage', name: 'Thai Pork Sausage', desc: 'A traditional fermented Thai sausage made with ground pork, sticky rice, and fragrant seasonings. Served with fresh sliced ginger, whole peanuts and slices of cucumber.', price: 5.00, allergens: [] }
      ]},
      { id: 'soup', title: 'Soup', items: [
        { id: 'tom-yum', name: 'Tom Yum Soup üå∂Ô∏èüå∂Ô∏è', desc: 'A vibrant and aromatic Thai classic featuring a hot and sour clear broth infused with lemongrass, galangal, and kaffir lime leaves.', price: 6.50, allowedModifiers: ['chicken','prawn','tofu','vegetable'], modifierRequired: true, modifierMax: 2, spiceEnabled: true, spiceDefault: 2, allergens: ['fish','soya'] },
        { id: 'tom-kha', name: 'Tom Khaüå∂Ô∏è', desc: 'A creamy and aromatic Thai coconut soup featuring fragrant galangal, lemongrass, and kaffir lime leaves.', price: 5.50, allowedModifiers: ['chicken','prawn','tofu','vegetable'], modifierRequired: true, modifierMax: 2, spiceEnabled: true, spiceDefault: 1, allergens: ['fish','dairy'] },
        { id: 'dumpling-broth', name: 'Chicken Steamed Dumplings Broth (Gaew Naam)', desc: 'A savoury and flavourful broth with fragrant chicken-stuffed wontons.', price: 5.50, allergens: ['gluten','egg','soya'] }
      ]},
      { id: 'salad', title: 'Salad', items: [
        { id: 'papaya-salad', name: 'Green Papaya Salad (Som Tam)üå∂Ô∏èüå∂Ô∏èüå∂Ô∏è', desc: 'A spicy, savoury, and sweet Thai salad made primarily of shredded green papaya.', price: 7.00, spiceEnabled: true, spiceDefault: 3, allergens: ['peanuts','fish','soya'] },
        { id: 'beef-salad', name: 'Spicy Beef Salad (Yum Nuea)üå∂Ô∏èüå∂Ô∏è', desc: 'A classic Thai salad with juicy grilled steak, tossed with crisp vegetables, fresh mint, coriander, and a tangy lime-fish sauce dressing.', price: 9.00, spiceEnabled: true, spiceDefault: 2, allergens: ['fish','soya'] },
        { id: 'pork-salad', name: 'Grilled Pork Salad (Nam Tok)üå∂Ô∏è', desc: 'This classic North-eastern Thai salad features smoky, charred grilled pork slices tossed with a fiery dressing of lime, fish sauce, and chili flakes.', price: 8.50, spiceEnabled: true, spiceDefault: 1, allergens: ['fish'] },
        { id: 'laab', name: 'Laabüå∂Ô∏èüå∂Ô∏è', desc: 'A vibrant and flavourful meat salad known for its harmony of spicy, sour, salty, and savoury flavours.', price: 8.00, spiceEnabled: true, spiceDefault: 2, allergens: ['fish'] }
      ]},
      { id: 'curry', title: 'Curry', items: [
        { id: 'rung-curry', name: 'Chefs Special Rainbow Curryüå∂Ô∏è', desc: 'Rich, mildly spiced curry.', price: 9.50, allowedModifiers: ['chicken','tofu','pork','beef','vegetable','prawn'], modifierRequired: true, spiceEnabled: true, spiceDefault: 1, allergens: ['fish','soya'] },
        { id: 'green-curry', name: 'Green Curryüå∂Ô∏èüå∂Ô∏è', desc: 'Creamy coconut curry with green chilli paste.', price: 9.50, allowedModifiers: ['chicken','tofu','pork','beef','vegetable','prawn'], modifierRequired: true, modifierMax: 2, img: 'images/greencurry.jpg', spiceEnabled: true, spiceDefault: 2, allergens: ['fish','soya'] },
        { id: 'red-curry', name: 'Red Curryüå∂Ô∏è', desc: 'Coconut milk, red curry paste, Thai basil.', price: 9.50, allowedModifiers: ['chicken','tofu','pork','beef','vegetable','prawn'], modifierRequired: true, spiceEnabled: true, spiceDefault: 1, allergens: ['fish','soya'] },
        { id: 'massaman-curry', name: 'Massaman Curry', desc: 'Mild curry with potatoes, onions, peanuts.', price: 9.50, allowedModifiers: ['chicken','tofu','pork','beef','vegetable','prawn'], modifierRequired: true, spiceEnabled: true, spiceDefault: 0, allergens: ['peanuts','fish','soya'] },
        { id: 'panang-curry', name: 'Panang Curryüå∂Ô∏è', desc: 'Thick, savory-sweet red curry with lime.', price: 9.50, allowedModifiers: ['chicken','tofu','pork','beef','vegetable','prawn'], modifierRequired: true, spiceEnabled: true, spiceDefault: 1, allergens: ['fish','soya'] }
      ]},
      { id: 'stir-fry', title: 'Stir Fry', items: [
        { id: 'stir-basil', name: 'Stir Fried Chilli & Basil (Pad Kra Pao)üå∂Ô∏èüå∂Ô∏è', desc: 'Street food classic with holy basil.', price: 8.50, allowedModifiers: ['chicken','beef','pork','tofu','vegetable','prawn','fried-egg' ], modifierRequired: true, modifierMax: 2, spiceEnabled: true, spiceDefault: 2, allergens: ['soya'] },
        { id: 'stir-ginger', name: 'Stir Fried Ginger (Pad Khing)üå∂Ô∏è', desc: 'Zesty ginger-forward stir fry.', price: 8.50, allowedModifiers: ['chicken','beef','pork','tofu','vegetable','prawn' ], modifierRequired: true, modifierMax: 2, spiceEnabled: true, spiceDefault: 1, allergens: ['soya'] },
        { id: 'stir-cashew', name: 'Stir Fried Cashew Nuts', desc: 'Chicken, cashews, veg, savory-sweet sauce.', price: 8.50, allowedModifiers: ['batter-chicken','tofu' ], modifierRequired: true, modifierMax: 2, spiceEnabled: true, spiceDefault: 1, allergens: ['tree_nuts','soya','sesame'] },
        { id: 'stir-sweetsour', name: 'Sweet & Sour (Pad Priew Wan)', desc: 'Veg, pineapple, peppers, onions, tomatoes.', price: 8.50, allowedModifiers: ['batter-chicken','tofu' ], modifierRequired: true, modifierMax: 2, spiceEnabled: true, spiceDefault: 0, allergens: ['soya'] },
        { id: 'stir-yellow', name: 'Stir Fried Yellow Curry (Pad Pong Karee)', desc: 'Mild yellow curry stir-fry.', price: 8.50, allowedModifiers: ['chicken','beef','pork','tofu','vegetable','prawn' ], modifierRequired: true, modifierMax: 2, spiceEnabled: true, spiceDefault: 1, allergens: ['egg','soya','mustard'] },
        { id: 'stir-chilli', name: 'Stir Fried Chilli Paste (Pad Nam Prik Pao)üå∂Ô∏èüå∂Ô∏è', desc: 'Roasted chilli paste sauce.', price: 8.50, allowedModifiers: ['chicken','beef','pork','tofu','vegetable','prawn' ], modifierRequired: true, modifierMax: 2, spiceEnabled: true, spiceDefault: 2, allergens: ['soya'] },
        { id: 'stir-pepper', name: 'Stir Fried Black Pepper Sauce', desc: 'Aromatic black pepper sauce.', price: 7.50, allowedModifiers: ['batter-chicken','beef','pork','tofu','vegetable','prawn' ], modifierRequired: true, modifierMax: 2, spiceEnabled: true, spiceDefault: 1, allergens: ['soya'] }
      ]},
      { id: 'noodles', title: 'Noodles & Rice', items: [
        { id: 'chef-pad-thai', name: 'Chefs Special Pad Thaiüå∂Ô∏è', desc: 'Rice noodles, tamarind, egg, bean sprouts.', price: 8.50, allowedModifiers: ['chicken','tofu','pork','beef','vegetable','prawn'], modifierRequired: true, spiceEnabled: true, spiceDefault: 1, allergens: ['egg','fish','soya','peanuts'] },
        { id: 'pad-thai', name: 'Pad Thai', desc: 'Rice noodles, tamarind sauce, egg, bean sprouts.', price: 8.50, allowedModifiers: ['chicken','tofu','pork','beef','vegetable','prawn'], modifierRequired: true, modifierMax: 2, spiceEnabled: true, spiceDefault: 0, allergens: ['egg','fish','soya','peanuts'] },
        { id: 'pad-see-ew', name: 'Thai Stir Fried Noodles (Pad See Ew)', desc: 'Wide rice noodles, Chinese broccoli, egg.', price: 8.50, allowedModifiers: ['chicken','tofu','pork','beef','vegetable','prawn'], modifierRequired: true, modifierMax: 2, spiceEnabled: true, spiceDefault: 0, allergens: ['egg','soya'] },
        { id: 'fried-rice', name: 'Thai Special Fried Rice (Khao Pad)', desc: 'Aromatic jasmine rice, classic seasoning.', price: 7.50, allowedModifiers: ['chicken','tofu','pork','beef','vegetable','prawn'], modifierRequired: true, spiceEnabled: true, spiceDefault: 0, allergens: ['egg','soya'] }
      ]},
      { id: 'sides', title: 'Side Dishes', items: [
        { id: 'jasmine-rice', name: 'Jasmine Rice (Khao Suay)', desc: 'Fragrant, long-grain rice.', price: 2.00, allergens: [] },
        { id: 'egg-rice', name: 'Egg Fried Rice (Khao Pad Khai)', desc: 'Rice with egg, simple & comforting.', price: 2.50, allergens: ['egg','soya'] },
        { id: 'sticky-rice', name: 'Sticky Rice (Khao Neow)', desc: 'Perfect sticky jasmine rice.', price: 2.50, allergens: [] },
        { id: 'coconut-ricee', name: 'Coconut Rice (Khao Man)', desc: 'Jasmine rice simmered in coconut milk.', price: 0.50, allergens: ['dairy'] }
      ]}
    ];

    const MODIFIERS = [
      { id: 'chicken', name: 'Chicken', delta: 0.00 },
      { id: 'beef', name: 'Beef', delta: 1.00 },
      { id: 'pork', name: 'Pork', delta: 0.75 },
      { id: 'tofu', name: 'Tofu', delta: 0.00 },
      { id: 'prawn', name: 'Prawn', delta: 1.50 },
      { id: 'vegetable', name: 'Vegetable', delta: 0.00 },
      { id: 'fried-egg', name: 'Fried Egg', delta: 1.00 },
      { id: 'batter-chicken', name: 'Battered Chicken', delta: 1.00 }
    ];

    // ---------- State ----------
    let basket = []; // { name, itemId, mods:[{id,name,delta}], unitPrice, qty, img, spice }
	window.basket = basket;  // expose the array reference to the second script
    const ITEMS_BY_ID = new Map();
	
	// remove chilli emojis that are baked into menu item names
		const CHILLI_RE = /üå∂Ô∏è+/g;
		function nameWithoutChillies(str) {
		  return (str || '')
			.replace(CHILLI_RE, '')
			.replace(/\s{2,}/g, ' ')
			.trim();
		}



    // ---------- Helpers ----------
    function formatCurrency(n){ const cents = Math.round((n + Number.EPSILON) * 100); return '¬£' + (cents/100).toFixed(2); }
    function roundToTwo(n){ return Math.round((n + Number.EPSILON) * 100) / 100; }
    function chilliIcons(n){ return 'üå∂Ô∏è'.repeat(Math.max(0, Math.min(3, n||0))); }
	
	
		function headerOffsetPx() {
		  const h = document.querySelector('header');
		  return (h ? h.getBoundingClientRect().height : 0) + 8; // add a little gap
		}

		function CategoryIntoView(bodyEl) {
		  const y = bodyEl.getBoundingClientRect().top + window.pageYOffset - headerOffsetPx();
		  window.scrollTo({ top: y, behavior: 'smooth' });
		}

		function attachAccordion(header, body) {
		  header.addEventListener('click', () => {
			const opening = !body.classList.contains('open');

			// Close all others first
			document.querySelectorAll('.category-body.open').forEach(b => {
			  if (b !== body) {
				b.classList.remove('open');
				b.style.maxHeight = '0px';
				const ct = b.previousElementSibling?.querySelector('.caret');
				if (ct) ct.textContent = '‚ñ∂';
			  }
			});

			if (opening) {
			  // Open this one
			  body.classList.add('open');
			  body.style.maxHeight = body.scrollHeight + 'px';
			  const ct = header.querySelector('.caret');
			  if (ct) ct.textContent = '‚ñº';

			  // Wait for layout to settle, then scroll accurately
			  requestAnimationFrame(() => {
				requestAnimationFrame(() => scrollCategoryIntoView(body));
			  });

			} else {
			  // Close this one
			  body.classList.remove('open');
			  body.style.maxHeight = '0px';
			  const ct = header.querySelector('.caret');
			  if (ct) ct.textContent = '‚ñ∂';
			}
		  });
		}

		function getHeaderOffset(){
		  const h = document.querySelector('.site-header') || document.querySelector('header');
		  return (h ? Math.round(h.getBoundingClientRect().height) : 0) + 12; // breathing room
		}


		function scrollPreciselyTo(el) {
		  if (!el) return;
		  const y = el.getBoundingClientRect().top + window.scrollY - getHeaderOffset();
		  window.scrollTo({ top: y, behavior: 'smooth' });
		}

		function updateHeaderOffsetVar() {
		  const header = document.querySelector('header');
		  const offset = (header ? header.getBoundingClientRect().height : 0) + 8; // breathing room
		  document.documentElement.style.setProperty('--header-offset', offset + 'px');
		}
		window.addEventListener('load', updateHeaderOffsetVar);
		window.addEventListener('resize', updateHeaderOffsetVar);
		updateHeaderOffsetVar();


    // ---------- Build menu (accordion categories) ----------
    function buildMenu(){
      const container = document.getElementById('menu-list');
      container.innerHTML = '';

      MENU_CATEGORIES.forEach(cat => {
        const catEl = document.createElement('div'); catEl.className = 'category';
        const header = document.createElement('div'); header.className = 'category-header';
        header.innerHTML = `<h3>${cat.title}</h3><div class="caret">‚ñ∂</div>`;
        const body = document.createElement('div'); body.className = 'category-body';
		

        cat.items.forEach(item => {
          ITEMS_BY_ID.set(item.id, item);

          const el = document.createElement('div'); el.className = 'menu-item';
          el.dataset.id = item.id;
          el.dataset.price = item.price;
          if (item.allowedModifiers) el.dataset.allowedModifiers = item.allowedModifiers.join(',');
          if (item.modifierRequired) el.dataset.modifierRequired = 'true';
          if (item.modifiersMulti) el.dataset.modifiersMulti = 'true';
          if (item.modifierMax) el.dataset.modifierMax = String(item.modifierMax);
          if (item.img) el.dataset.img = item.img;
          if (item.spiceEnabled) el.dataset.spiceEnabled = 'true';
          if (typeof item.spiceDefault === 'number') el.dataset.spiceDefault = String(item.spiceDefault);

          const allergenHTML = renderAllergenIconsCompact(item.allergens || []);

          el.innerHTML = `
            <div class="meta">
              <div class="title">${item.name}</div>
              <div class="muted small">${item.desc || ''}</div>
              ${allergenHTML}
            </div>
            <div style="text-align:right">
              <div class="price">${formatCurrency(item.price)}</div>
              <div style="margin-top:8px">
                <button class="btn btn-accent" data-id="${item.id}">customise</button>
              </div>
            </div>
          `;
          body.appendChild(el);
        });

        // Accordion behavior
        header.addEventListener('click', () => {
  // close others
  document.querySelectorAll('.category-body.open').forEach(b => {
    if (b !== body) {
      b.classList.remove('open');
      b.style.maxHeight = '0px';
      const c = b.previousElementSibling?.querySelector('.caret');
      if (c) c.textContent = '‚ñ∂';
    }
  });

  const wasOpen = body.classList.contains('open');

  if (wasOpen) {
    // collapse this one
    body.classList.remove('open');
    body.style.maxHeight = '0px';
    const c = header.querySelector('.caret'); if (c) c.textContent = '‚ñ∂';
    return;
  }

  // open this one
  body.classList.add('open');
  body.style.maxHeight = body.scrollHeight + 'px';
  const c = header.querySelector('.caret'); if (c) c.textContent = '‚ñº';

    // IMPORTANT: scroll AFTER layout has updated so we know exact height
		requestAnimationFrame(() => {
		  // Smoothly align the whole category under the sticky header.
		  // (scroll-margin-top on .category does the offset math for us)
		  catEl.scrollIntoView({ behavior: 'smooth', block: 'start' });

		  // Safety net: if images load and change height, nudge again shortly after.
		  setTimeout(() => {
			catEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
		  }, 150);
		});

	});




        catEl.appendChild(header);
        catEl.appendChild(body);
        container.appendChild(catEl);
      });
    }

    // ---------- Order rendering ----------
			function renderOrder(){
		  const orderListEl  = document.getElementById('order-list');
		  const orderTotalEl = document.getElementById('order-total');

		  orderListEl.innerHTML = '';

		  if (basket.length === 0){
			orderListEl.innerHTML = '<div class="muted small">No items yet ‚Äî add something from the menu.</div>';
			orderTotalEl.textContent = formatCurrency(0);
			return;
		  }

		  basket.forEach((row, idx) => {
			const r = document.createElement('div');
			r.className = 'order-row';

			const leftWrap = document.createElement('div');
			leftWrap.style.display = 'flex';
			leftWrap.style.alignItems = 'center';
			leftWrap.style.gap = '10px';

			const img = document.createElement('img');
			img.className = 'item-thumb';
			img.alt = row.name;
			img.loading = 'lazy';
			img.src = (row.img && row.img.trim())
			  ? row.img
			  : 'data:image/svg+xml;utf8,' + encodeURIComponent(
				`<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120">
				   <rect width="100%" height="100%" fill="#f1f1f1"/>
				   <text x="50%" y="50%" text-anchor="middle" dominant-baseline="middle"
						 font-family="sans-serif" font-size="12" fill="#999">No image</text>
				 </svg>`
			  );

			// ‚úÖ HERE: use clean name (no built-in chillies)
			const cleanName = nameWithoutChillies(row.name);

			const details = [];
			if (row.mods && row.mods.length) {
			  details.push(row.mods.map(m => m.name).join(', '));
			}
			if (typeof row.spice === 'number') {
			  details.push(chilliIcons(row.spice));
			}

			const text = document.createElement('div');
			text.innerHTML = `
			  <div style="font-weight:700">
				${cleanName}
				${details.length ? ` <span class="muted small">‚Ä¢ ${details.join(' ‚Ä¢ ')}</span>` : ''}
			  </div>
			  <div class="muted small">Unit: ${formatCurrency(row.unitPrice)}</div>
			`;

			const right = document.createElement('div');
			right.style.textAlign = 'right';
			right.innerHTML = `
			  <div style="font-weight:800">${formatCurrency(roundToTwo(row.unitPrice * row.qty))}</div>
			  <div style="margin-top:8px;display:flex;gap:8px;align-items:center;justify-content:flex-end">
				<button class="btn btn-ghost" data-action="dec" data-idx="${idx}">-</button>
				<div class="muted">${row.qty}</div>
				<button class="btn btn-ghost" data-action="inc" data-idx="${idx}">+</button>
				<button class="btn" style="background:transparent;color:#b02a2a;border:none;padding:6px 8px" data-action="remove" data-idx="${idx}">Remove</button>
			  </div>
			`;

			leftWrap.appendChild(img);
			leftWrap.appendChild(text);
			r.appendChild(leftWrap);
			r.appendChild(right);
			orderListEl.appendChild(r);
		  });

		  const total = basket.reduce((s, i) => s + i.unitPrice * i.qty, 0);
		  orderTotalEl.textContent = formatCurrency(roundToTwo(total));
		}


    // ---------- Modal (customise) ----------
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalBase = document.getElementById('modal-base');
    const qtyInput = document.getElementById('qty-input');
    const qtyIncr = document.getElementById('qty-incr');
    const qtyDecr = document.getElementById('qty-decr');
    const modsEl = document.getElementById('mods');
    const unitPriceEl = document.getElementById('unit-price');
    const modalClose = document.getElementById('modal-close');
    const modalCancel = document.getElementById('modal-cancel');
    const modalAdd = document.getElementById('modal-add');
    const modalImg = document.getElementById('modal-img');
    const modRequiredNote = document.getElementById('mod-required-note');
    const modLimitNote = document.getElementById('mod-limit-note');
    const modalAllWrap = document.getElementById('modal-allergens-wrap');
    const modalAll = document.getElementById('modal-allergens');
    const spiceWrap = document.getElementById('spice-wrap');
    const spiceButtons = document.getElementById('spice-buttons');

    let currentItem = null;
    let selectedMods = new Set();
    let currentAllowedMods = null;
    let currentRequires = false;
    let currentMulti = false;
    let currentMax = null;
    let currentSpice = null; // 0..3 or null

    function buildModifierChips(allowed, required=false, multi=false, max=null){
      modsEl.innerHTML = '';
      selectedMods.clear();
      currentAllowedMods = Array.isArray(allowed) && allowed.length ? allowed.slice() : null;
      currentRequires = !!required;
      currentMulti = !!multi || (typeof max === 'number' && max > 0);
      currentMax = (typeof max === 'number' && max > 0) ? max : null;

      if(currentRequires && currentAllowedMods){ modRequiredNote.style.display = 'block'; modalAdd.disabled = true; }
      else { modRequiredNote.style.display = 'none'; modalAdd.disabled = false; }

      if(currentMulti && currentMax){ modLimitNote.style.display = 'block'; modLimitNote.textContent = `Choose up to ${currentMax} options`; }
      else { modLimitNote.style.display = 'none'; }

      if(!currentAllowedMods){ modsEl.style.display = 'none'; return; }
      modsEl.style.display = 'flex';

      MODIFIERS.forEach(m => {
        if(!currentAllowedMods.includes(m.id)) return;
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'chip';
        btn.innerHTML = `${m.name}${m.delta ? ` (+${formatCurrency(m.delta)})` : ''}`;
        btn.dataset.id = m.id;

        btn.addEventListener('click', () => {
          if(currentMulti){
            if(selectedMods.has(m.id)){
              selectedMods.delete(m.id);
              btn.classList.remove('selected');
            } else {
              if(currentMax && selectedMods.size >= currentMax){
                btn.animate([{transform:'translateY(-2px)'},{transform:'translateY(0)'}],{duration:140});
                return;
              }
              selectedMods.add(m.id);
              btn.classList.add('selected');
            }
            if(currentRequires) modalAdd.disabled = (selectedMods.size === 0);
            if(currentMax && currentMulti){ modLimitNote.textContent = `Selected ${selectedMods.size}/${currentMax}`; }
          } else {
            if(selectedMods.has(m.id)){
              selectedMods.delete(m.id);
              btn.classList.remove('selected');
            } else {
              selectedMods.clear();
              modsEl.querySelectorAll('.chip').forEach(c=>c.classList.remove('selected'));
              selectedMods.add(m.id);
              btn.classList.add('selected');
            }
            if(currentRequires) modalAdd.disabled = (selectedMods.size === 0);
          }
          updateUnitPricePreview();
        });

        modsEl.appendChild(btn);
      });
    }
	
	// ---------- Success popup (matches #order-success in HTML) ----------
	const orderSuccess      = document.getElementById('order-success');
	const orderSuccessX     = document.getElementById('order-success-x');
	const orderSuccessClose = document.getElementById('order-success-close');

	function showOrderSuccess({ ref, subtotal, delivery, total, orderType }, items, preferredTimeStr) {
	  if (!orderSuccess) {
		// fallback
		alert(`Order placed! ${ref}`);
		return;
	  }

	  // 1) header
	  const titleEl = document.getElementById('order-success-title');
	  if (titleEl) {
		// ‚¨ÖÔ∏è use ref AS-IS, do NOT add "RTK-" again
		titleEl.textContent = `Order confirmed ‚Äî ${ref}`;
	  }

	  // 2) message
	  const msgEl = document.getElementById('order-success-msg');
	  if (msgEl) {
		const suffix = orderType === 'delivery' ? 'delivery' : 'collection';
		const note = preferredTimeStr
		  ? `Thanks! We‚Äôll contact you to confirm your ${suffix} time (${preferredTimeStr}).`
		  : `Thanks! We‚Äôll contact you to confirm your ${suffix}.`;
		msgEl.textContent = note;
	  }

	  // 3) items
	  const listEl = document.getElementById('order-success-items');
	  if (listEl) {
		listEl.innerHTML = '';
		items.forEach(row => {
		  const details = [];
		  if (row.mods?.length) details.push(row.mods.map(m => m.name).join(', '));
		  if (typeof row.spice === 'number') details.push('üå∂Ô∏è'.repeat(row.spice));

		  const div = document.createElement('div');
		  div.style.padding = '6px 0';
		  div.style.borderBottom = '1px dashed #eee';
		  div.innerHTML = `
			${row.qty} √ó ${row.name}
			${details.length ? ` <span class="muted small">‚Ä¢ ${details.join(' ‚Ä¢ ')}</span>` : ''}
		  `;
		  listEl.appendChild(div);
		});
	  }

	  // 4) total
	  const totalEl = document.getElementById('order-success-total');
	  if (totalEl) {
		totalEl.textContent = formatCurrency(total);
	  }

	  orderSuccess.style.display = 'flex';
	}

	// close buttons
	if (orderSuccessX)     orderSuccessX.addEventListener('click', () => orderSuccess.style.display = 'none');
	if (orderSuccessClose) orderSuccessClose.addEventListener('click', () => orderSuccess.style.display = 'none');
	if (orderSuccess) {
	  orderSuccess.addEventListener('click', (e) => {
		if (e.target === orderSuccess) orderSuccess.style.display = 'none';
	  });
	}


	// make it available to the second script
	window.showOrderSuccess = showOrderSuccess;

	
		// ----  (pure front-end) ----

	(function(){
	  const wrap  = document.getElementById('order-success');
	  const title = document.getElementById('order-success-title');
	  const msg   = document.getElementById('order-success-msg');
	  const list  = document.getElementById('order-success-items');
	  const totalEl = document.getElementById('order-success-total');
	  const btnClose = document.getElementById('order-success-close');
	  const btnX     = document.getElementById('order-success-x');

	  function hide() {
		if (wrap) wrap.style.display = 'none';
	  }

	  // expose a global helper we can call later (kept for backwards compatibility)
	function showOrderSuccess(orderId, items, total, orderType, preferredTime) {
	  // If the new-style function exists, delegate to it
	  if (typeof window.showOrderSuccessNew === 'function') {
		window.showOrderSuccessNew(
		  {
			// if checkout already passed "RTK-012", keep it;
			// if it passed just "012", add RTK-
			ref: (typeof orderId === 'string' && orderId.startsWith('RTK-'))
			  ? orderId
			  : `RTK-${orderId}`,
			subtotal: 0,
			delivery: 0,
			total: total || 0,
			orderType: orderType || 'collection'
		  },
		  items || [],
		  preferredTime || null
		);
		return;
	  }
	  

	  // Fallback if the new function isn‚Äôt there
	  alert(
		(typeof orderId === 'string' ? orderId : `RTK-${orderId}`) ||
		'Order placed!'
	  );
	}


	  if (btnClose) btnClose.addEventListener('click', hide);
	  if (btnX)     btnX.addEventListener('click', hide);
	  if (wrap)     wrap.addEventListener('click', e => {
		if (e.target === wrap) hide();
	  });

	  // make available to other scripts
	  window.showOrderSuccess = showOrderSuccess;
	})();


    function buildSpiceSelector(enabled, defaultLevel=0){
      if(!enabled){
        spiceWrap.style.display = 'none';
        spiceButtons.innerHTML = '';
        currentSpice = null;
        return;
      }
      spiceWrap.style.display = 'block';
      spiceButtons.innerHTML = '';
      currentSpice = Math.max(0, Math.min(3, Number(defaultLevel)||0));

      const labels = [
        {v:0, text:'No spice'},
        {v:1, text:'Mild üå∂Ô∏è'},
        {v:2, text:'Medium üå∂Ô∏èüå∂Ô∏è'},
        {v:3, text:'Very spicy üå∂Ô∏èüå∂Ô∏èüå∂Ô∏è'}
      ];
      labels.forEach(l=>{
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'spice-btn' + (l.v===currentSpice ? ' active':'');
        b.textContent = l.text;
        b.setAttribute('aria-pressed', l.v===currentSpice ? 'true':'false');
        b.addEventListener('click', ()=>{
          currentSpice = l.v;
          [...spiceButtons.querySelectorAll('.spice-btn')].forEach(x=>{
            x.classList.remove('active'); x.setAttribute('aria-pressed','false');
          });
          b.classList.add('active'); b.setAttribute('aria-pressed','true');
        });
        spiceButtons.appendChild(b);
      });
    }

    function closeModal(){
      modal.style.display = 'none';
      currentItem = null;
      selectedMods.clear();
      currentAllowedMods = null;
      if (modalImg){ modalImg.removeAttribute('src'); modalImg.style.display = 'none'; }
      buildSpiceSelector(false);
    }

    function updateUnitPricePreview(){
      if(!currentItem) return;
      const base = Number(modalBase.dataset.price) || 0;
      let modsTotal = 0;
      selectedMods.forEach(id => {
        if(!currentAllowedMods || !currentAllowedMods.includes(id)) return;
        const m = MODIFIERS.find(x => x.id === id);
        if(m){ modsTotal += m.delta; }
      });
      const unit = roundToTwo(base + modsTotal);
      unitPriceEl.textContent = formatCurrency(unit);
    }

    function opencustomise(itemId){
      const found = ITEMS_BY_ID.get(itemId);
      if(!found) return;
      currentItem = found;

      const allowed = Array.isArray(found.allowedModifiers) ? found.allowedModifiers : null;
      const requiresModifier = !!found.modifierRequired;
      const isMulti = !!found.modifierMax || !!found.modifiersMulti;
      const max = (typeof found.modifierMax === 'number' && found.modifierMax > 0) ? found.modifierMax : null;

      buildModifierChips(allowed, requiresModifier, isMulti, max);

      modalTitle.textContent = `customise ‚Äî ${found.name}`;
      modalBase.dataset.price = found.price;
      modalBase.textContent = `Base price: ${formatCurrency(found.price)}`;
      qtyInput.value = 1;
      updateUnitPricePreview();

      if (modalImg) {
        if (found.img) { modalImg.src = found.img; modalImg.style.display = 'block'; }
        else { modalImg.removeAttribute('src'); modalImg.style.display = 'none'; }
      }

      if (found.allergens && found.allergens.length) {
        modalAll.innerHTML = renderAllergenBadges(found.allergens);
        modalAllWrap.style.display = 'block';
      } else {
        modalAll.innerHTML = '';
        modalAllWrap.style.display = 'none';
      }

      buildSpiceSelector(!!found.spiceEnabled, typeof found.spiceDefault==='number'?found.spiceDefault:0);

      modal.style.display = 'flex';
    }

    document.getElementById('qty-incr').addEventListener('click', ()=>{ qtyInput.value = Math.max(1, parseInt(qtyInput.value || '1') + 1); });
    document.getElementById('qty-decr').addEventListener('click', ()=>{ qtyInput.value = Math.max(1, parseInt(qtyInput.value || '1') - 1); });

    document.getElementById('modal-close').addEventListener('click', closeModal);
    document.getElementById('modal-cancel').addEventListener('click', closeModal);
    modal.addEventListener('click', (ev) => { if(ev.target === modal) closeModal(); });

    document.getElementById('modal-add').addEventListener('click', ()=>{
      if(!currentItem) return;

      if(currentItem.modifierRequired && selectedMods.size === 0){
        modRequiredNote.style.display = 'block';
        modsEl.scrollIntoView({behavior:'smooth', block:'center'});
        return;
      }
      if(currentMulti && currentMax && selectedMods.size > currentMax){ return; }

      const base = Number(modalBase.dataset.price) || 0;
      const modsArr = []; let modsTotal = 0;
      selectedMods.forEach(id => {
        if(!currentAllowedMods || !currentAllowedMods.includes(id)) return;
        const m = MODIFIERS.find(x => x.id === id);
        if(m){ modsTotal += m.delta; modsArr.push(m); }
      });
      const unitPrice = roundToTwo(base + modsTotal);
      const qty = Math.max(1, parseInt(qtyInput.value || '1'));

      basket.push({
        name: currentItem.name,
        itemId: currentItem.id,
        mods: modsArr,
        unitPrice,
        qty,
        img: currentItem.img || '',
        spice: currentSpice // 0..3 or null
      });
      closeModal();
      renderOrder();
    });

    document.getElementById('menu-list').addEventListener('click', e => {
      const btn = e.target.closest('button');
      if(!btn || !btn.dataset.id) return;
      opencustomise(btn.dataset.id);
    });
    document.getElementById('order-panel').addEventListener('click', e => {
      const btn = e.target.closest('button');
      if(!btn) return;
      const action = btn.dataset.action;
      const idx = Number(btn.dataset.idx);
      if(action === 'inc'){ basket[idx].qty += 1; renderOrder(); }
      if(action === 'dec'){ basket[idx].qty = Math.max(1, basket[idx].qty - 1); renderOrder(); }
      if(action === 'remove'){ basket.splice(idx, 1); renderOrder(); }
    });

    // Lightbox
    document.querySelectorAll('#food-grid img').forEach(img => {
      img.addEventListener('click', ()=> {
        const lb = document.getElementById('lightbox');
        const lbImg = document.getElementById('lightbox-img');
        lbImg.src = img.src || '';
        lb.style.display = 'flex';
      });
    });
    document.getElementById('lightbox').addEventListener('click', (e) => {
      if(e.target.id === 'lightbox' || e.target.id === 'lightbox-img') e.currentTarget.style.display = 'none';
    });

    document.addEventListener('keydown', (e) => {
      if(e.key === 'Escape' && modal.style.display === 'flex') closeModal();
      if(e.key === 'Escape' && checkoutModal.style.display === 'flex') closeCheckout();
      if(e.key === 'Escape' && successModal.style.display === 'flex') hideOrderSuccess();
    });

    // Build & first render
    buildMenu();
    renderOrder();
	// expose helpers that the second script uses
	window.formatCurrency = formatCurrency;
	window.openCheckout = openCheckout;
	window.orderMsg = document.getElementById('order-msg');
	window.basket = basket;
	window.renderOrder = renderOrder;
	window.roundToTwo = roundToTwo;
	window.chilliIcons = chilliIcons;
	window.nameWithoutChillies = nameWithoutChillies;
	

	}); // end DOMContentLoaded
</script>
	<script>
	  if (typeof window.formatCurrency !== 'function') {
		window.formatCurrency = n => '¬£' + Number(n || 0).toFixed(2);
	  }
	  if (typeof window.roundToTwo !== 'function') {
		window.roundToTwo = n => Math.round((n || 0) * 100) / 100;
	  }
	</script>
	
	<script>
	  // hard-sanitize anything we send to the PDF
	  function pdfSafe(str) {
		return (str || '')
		  // remove chilli emoji (both with vs16 and plain)
		  .replace(/üå∂Ô∏è/gu, '')
		  .replace(/üå∂/g, '')
		  // remove any emoji / symbols in the big emoji planes
		  .replace(/[\u{1F000}-\u{1FFFF}]/gu, '')
		  // finally, strip anything not basic ASCII
		  .replace(/[^\x20-\x7E]/g, '')
		  .trim();
	  }
</script>

	<!-- jsPDF (must be before our downloadReceipt) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>



  <!-- Supabase JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Init Supabase
    const SUPABASE_URL = 'https://ubyjrrsvbbqomitpaidb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVieWpycnN2YmJxb21pdHBhaWRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5NTYyNjMsImV4cCI6MjA3NjUzMjI2M30.WTllxO5KnaMI0i1d4VHNBhjLuRMfu4_Xx5arqZmYevw';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Checkout modal helpers
    const checkoutModal = document.getElementById('checkout-modal');
    const checkoutClose = document.getElementById('checkout-close');
    const checkoutCancel = document.getElementById('checkout-cancel');
    const checkoutForm = document.getElementById('checkout-form');
    const checkoutMsg = document.getElementById('checkout-msg');
    const checkoutSubtotalEl = document.getElementById('checkout-subtotal');
    const checkoutDeliveryEl = document.getElementById('checkout-delivery');
    const checkoutTotalEl = document.getElementById('checkout-total');
    const deliveryNote = document.getElementById('delivery-note');
    const orderMsg = document.getElementById('order-msg');
    const openCheckoutBtn = document.getElementById('open-checkout');

    const orderTypeRadios = document.querySelectorAll('input[name="order-type"]');
    let checkoutBaseSubtotal = 0;

    function calcDeliveryFee(subtotal, orderType){
      if(orderType !== 'delivery') return 0;
      return subtotal < 20 ? 3 : 0;
    }
    function recomputeCheckoutTotals(){
      const orderType = document.querySelector('input[name="order-type"]:checked')?.value || 'collection';
      const fee = calcDeliveryFee(checkoutBaseSubtotal, orderType);
      const total = checkoutBaseSubtotal + fee;
      deliveryNote.style.display = (orderType === 'delivery') ? 'block' : 'none';
      checkoutSubtotalEl.textContent = formatCurrency(checkoutBaseSubtotal);
      checkoutDeliveryEl.textContent = formatCurrency(fee);
      checkoutTotalEl.textContent = formatCurrency(total);
    }
    orderTypeRadios.forEach(r => r.addEventListener('change', recomputeCheckoutTotals));

    function openCheckout(subtotal){
      checkoutBaseSubtotal = Math.round(subtotal*100)/100;
      checkoutMsg.textContent = '';
      document.querySelector('input[name="order-type"][value="collection"]').checked = true;
      recomputeCheckoutTotals();
      // min for preferred time (now + 30 mins)
      const t = document.getElementById('cust-preferred-time');
      if (t){
        const now = new Date();
        now.setMinutes(now.getMinutes() + 30);
        const pad = n => String(n).padStart(2,'0');
        t.min = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
      }
      checkoutModal.style.display = 'flex';
    }
			function closeCheckout(){
		  if (checkoutModal) checkoutModal.style.display = 'none';
		}

		// safe listeners
		if (checkoutClose) {
		  checkoutClose.addEventListener('click', closeCheckout);
		}
		if (checkoutCancel) {
		  checkoutCancel.addEventListener('click', closeCheckout);
		}
		if (checkoutModal) {
		  checkoutModal.addEventListener('click', (e) => {
			if (e.target === checkoutModal) closeCheckout();
		  });
		}

		// Open checkout (safe)
		if (openCheckoutBtn) {
		  openCheckoutBtn.addEventListener('click', () => {
			if (!window.basket || window.basket.length === 0) {
			  if (orderMsg) {
				orderMsg.textContent = 'Your basket is empty.';
				orderMsg.style.color = '#b02a2a';
			  }
			  return;
			}
			if (orderMsg) orderMsg.textContent = '';
			const subtotal = window.basket.reduce((s, i) => s + i.unitPrice * i.qty, 0);
			openCheckout(subtotal);
		  });
		}


		// ---------- Helpers to call Supabase RPC & REST ----------
    async function getNextOrderRef(){
      // Calls public.get_next_order_number() and returns "RTK-###"
      const { data, error } = await supabase.rpc('get_next_order_number');
      if (error) { console.error('get_next_order_number failed', error); throw error; }
      const assigned = Array.isArray(data) ? data[0]?.assigned : (data?.assigned ?? data);
      const num = Number(assigned || 0);
      return 'RTK-' + String(num).padStart(3,'0');
    }
	
		// --- Success popup renderer (with Download PDF) ---
		window.__lastOrderForPdf = null;
		
		// helper: strip any üå∂Ô∏è from item names so we only show user's chosen level
		function stripChillies(str) {
		  return (str || '').replace(/üå∂Ô∏è+/g, '').replace(/\s{2,}/g, ' ').trim();
		}


		window.showOrderSuccessNew = function (summary, items, preferredTimeStr) {
		  const wrap     = document.getElementById('order-success');
		  const titleEl  = document.getElementById('order-success-title');
		  const msgEl    = document.getElementById('order-success-msg');
		  const listEl   = document.getElementById('order-success-items');
		  const totalEl  = document.getElementById('order-success-total');

		  if (!wrap) {
			alert(`Order placed! ${summary?.ref || ''}`);
			return;
		  }

		  // header
		  if (titleEl) {
			titleEl.textContent = `Order confirmed ‚Äî ${summary.ref}`;
		  }

		  // note
		  if (msgEl) {
			const suffix = summary.orderType === 'delivery' ? 'delivery' : 'collection';
			const note = preferredTimeStr
			  ? `Thanks! We‚Äôll contact you to confirm your ${suffix} time (${preferredTimeStr}).`
			  : `Thanks! We‚Äôll contact you to confirm your ${suffix} time.`;
			msgEl.textContent = note;
		  }

		  // items
		  if (listEl) {
			listEl.innerHTML = items.map((row) => {
	  const cleanName = stripChillies(row.name);
	  const hasMods  = row.mods && row.mods.length;
	  const hasSpice = typeof row.spice === 'number';
	  const spiceStr = hasSpice ? ' ' + 'üå∂Ô∏è'.repeat(Math.max(0, Math.min(3, row.spice))) : '';
	  return `
		<div style="padding:6px 0;border-bottom:1px dashed #eee">
		  ${row.qty} √ó ${cleanName}
		  ${hasMods ? `<span class="muted small"> ‚Ä¢ ${row.mods.map(m => m.name).join(', ')}</span>` : ''}
		  ${spiceStr}
		  <div class="muted small">Line: ${window.formatCurrency(row.qty * row.unitPrice)}</div>
		</div>
	  `;
	}).join('');

		  }

		  // total
		  if (totalEl) {
			totalEl.textContent = window.formatCurrency(summary.total);
		  }
		  
		    // hook up the "Download receipt" button
  const dlBtn = document.getElementById('order-success-download');
  if (dlBtn) {
    dlBtn.onclick = () => {
      // make it loud so we see it even if console is filtered
      console.error('[Receipt] download clicked', items);
      if (typeof window.downloadReceipt === 'function') {
        window.downloadReceiptPlain(summary, items, preferredTimeStr);
      }
    };
  }


		  // ‚úÖ store for PDF generation
		  window.__lastOrderForPdf = { summary, items, preferredTimeStr };

		  wrap.style.display = 'flex';
		};


    // Submit checkout ‚Üí Supabase (with upsert customer + order_ref + preferred_time)
    checkoutForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      checkoutMsg.style.color = ''; checkoutMsg.textContent = 'Placing order‚Ä¶';

      const name = document.getElementById('cust-name').value.trim();
      const email = document.getElementById('cust-email').value.trim() || null;
      const phone = document.getElementById('cust-phone').value.trim() || null;
      const address = document.getElementById('cust-address').value.trim() || null;
      const notes = document.getElementById('cust-notes').value.trim() || null;
      const preferredTimeRaw = document.getElementById('cust-preferred-time').value; // '' or 'YYYY-MM-DDTHH:mm'
      const preferredTimeISO = preferredTimeRaw ? new Date(preferredTimeRaw).toISOString() : null;

      if(!name){ checkoutMsg.style.color = '#b02a2a'; checkoutMsg.textContent = 'Please enter your name.'; return; }

      const orderType = document.querySelector('input[name="order-type"]:checked')?.value || 'collection';
      const itemsSnapshot = basket.map(i => ({ ...i }));
      const subtotal = itemsSnapshot.reduce((s,i)=> s + i.unitPrice * i.qty, 0);
      const deliveryFee = (orderType === 'delivery' && subtotal < 20) ? 3.00 : 0.00;
      const total = subtotal + deliveryFee;

      function fail(step, err){
        console.error(`[Checkout] ${step} failed:`, err);
        checkoutMsg.style.color = '#b02a2a';
        checkoutMsg.textContent = `${step} failed: ${err?.message || err?.hint || 'Unknown error'}`;
      }

      try {
				// 1) get or create customer
		let customerId = null;

		// normalise
		const normEmail = email ? email.trim().toLowerCase() : null;
		const normPhone = phone ? phone.trim() : null;

		if (normEmail) {
		  // 1A. is there already a customer with this email?
		  const { data: existingByEmail, error: findEmailErr } = await supabase
			.from('customers')
			.select('id, phone')
			.eq('email', normEmail)
			.maybeSingle();

		  if (findEmailErr) return fail('Find customer (email)', findEmailErr);

		  if (existingByEmail) {
			// update that customer ‚Äì but only set phone if it's empty on that row
			const updatePayload = {
			  full_name: name,
			  address
			};
			if (!existingByEmail.phone && normPhone) {
			  // safe to set phone
			  updatePayload.phone = normPhone;
			}

			const { data: updated, error: updErr } = await supabase
			  .from('customers')
			  .update(updatePayload)
			  .eq('id', existingByEmail.id)
			  .select('id')
			  .single();

			if (updErr) return fail('Update customer (email)', updErr);
			customerId = updated.id;

		  } else {
			// 1B. no email yet ‚Üí try to insert
			// but phone might already exist on someone else, so we'll try with phone first,
			// and if that fails with duplicate phone, we retry without phone
			const baseInsert = {
			  full_name: name,
			  email: normEmail,
			  address
			};
			if (normPhone) baseInsert.phone = normPhone;

			let { data: inserted, error: insErr } = await supabase
			  .from('customers')
			  .insert([baseInsert])
			  .select('id')
			  .single();

			// if phone is duplicate, try again without phone
			if (insErr && insErr.code === '23505') {
			  // duplicate key ‚Üí try again without phone
			  const { data: inserted2, error: insErr2 } = await supabase
				.from('customers')
				.insert([{
				  full_name: name,
				  email: normEmail,
				  address
				}])
				.select('id')
				.single();

			  if (insErr2) return fail('Insert customer (email, no phone)', insErr2);
			  customerId = inserted2.id;
			} else if (insErr) {
			  return fail('Insert customer (email)', insErr);
			} else {
			  customerId = inserted.id;
			}
		  }

		} else if (normPhone) {
		  // no email, but we do have a phone ‚Üí find by phone
		  const { data: existingByPhone, error: findPhoneErr } = await supabase
			.from('customers')
			.select('id')
			.eq('phone', normPhone)
			.maybeSingle();

		  if (findPhoneErr) return fail('Find customer (phone)', findPhoneErr);

		  if (existingByPhone) {
			customerId = existingByPhone.id;
			// optionally update name/address
			await supabase
			  .from('customers')
			  .update({ full_name: name, address })
			  .eq('id', customerId);
		  } else {
			// create new with phone
			const { data: inserted, error: insErr } = await supabase
			  .from('customers')
			  .insert([{ full_name: name, phone: normPhone, address }])
			  .select('id')
			  .single();
			if (insErr) return fail('Insert customer (phone)', insErr);
			customerId = inserted.id;
		  }

		} else {
		  // no email, no phone ‚Üí just insert bare customer
		  const { data: inserted, error: insErr } = await supabase
			.from('customers')
			.insert([{ full_name: name, address }])
			.select('id')
			.single();
		  if (insErr) return fail('Insert customer (bare)', insErr);
		  customerId = inserted.id;
		}


        // 2) Get global sequential order ref
        let orderRef = 'RTK-???';
        try {
          orderRef = await getNextOrderRef();
        } catch (err) {
          console.warn('Falling back to timestamp-based ref');
          orderRef = 'RTK-' + Date.now();
        }

        // 3) Create order (attempt with preferred_time; if column missing, retry without)
        let orderId = null;
        const baseOrderPayload = {
          customer_id: customerId,
          subtotal: Number(subtotal.toFixed(2)),
          delivery_fee: Number(deliveryFee.toFixed(2)),
          order_type: orderType,
          notes,
          order_ref: orderRef
        };
        let { data: order, error: orderErr } = await supabase
          .from('orders')
          .insert([ { ...baseOrderPayload, preferred_time: preferredTimeISO } ])
          .select('id')
          .single();

        if (orderErr && orderErr.code === '42703') {
          // Column preferred_time missing ‚Üí retry without it
          const retry = await supabase.from('orders').insert([ baseOrderPayload ]).select('id').single();
          if (retry.error) return fail('Create order', retry.error);
          order = retry.data;
        } else if (orderErr) {
          return fail('Create order', orderErr);
        }
        orderId = order.id;

        // 4) Items
        const rows = itemsSnapshot.map(line => ({
          order_id: orderId,
          item_id: line.itemId,
          name: line.name,
          unit_price: Number(line.unitPrice.toFixed(2)),
          qty: line.qty,
          modifiers: (line.mods ?? []).map(m => ({ id: m.id, name: m.name, delta: m.delta })),
          spice: (typeof line.spice === 'number') ? line.spice : null,
          img: line.img || null
        }));
        const { error: itemsErr } = await supabase.from('order_items').insert(rows);
        if (itemsErr) return fail('Add order items', itemsErr);
		
		// after order + order_items succeed:
		try {
		  await fetch('https://YOUR-FUNCTION-URL/send-order-confirmation', {
			method: 'POST',
			headers: { 'Content-Type':'application/json' },
			body: JSON.stringify({
			  order_id: orderId,
			  order_ref: orderRef,
			  name,
			  email,
			  phone,
			  order_type: orderType,
			  preferred_time: preferredTimeRaw,
			  total
			})
		  });
		} catch (err) {
		  console.warn('[Order] Confirmation hook failed (non-blocking)', err);
		}


       // --- SUCCESS UI (step 2) ---
		checkoutMsg.textContent = '';
		closeCheckout?.(); // safe close if the function exists

		// snapshot BEFORE clearing
		const basketSnapshot = itemsSnapshot; // we already copied basket above

		// clear your UI basket and re-render
		basket.length = 0;
		renderOrder();

		// Pretty preferred time string (local)
		const prefPretty = preferredTimeRaw
		  ? new Date(preferredTimeRaw).toLocaleString([], { dateStyle: 'medium', timeStyle: 'short' })
		  : null;

		/* ---- FIX 1: make sure ref is a string like "RTK-012" ---- */
		let refText;
		if (orderRef && typeof orderRef === 'object') {
		  // e.g. RPC returned { assigned: 12 }
		  const num = Number(orderRef.assigned || orderRef.id || orderRef.value || 0);
		  refText = 'RTK-' + String(num).padStart(3, '0');
		} else {
		  // e.g. we already got "RTK-012" or "RTK-1730392039"
		  refText = String(orderRef);
		}

		/* ---- FIX 2: make sure total is numeric ---- */
		const subtotalNum = Number(subtotal) || 0;
		const deliveryNum = Number(deliveryFee) || 0;
		const grandTotal = subtotalNum + deliveryNum;

		showOrderSuccess(orderRef, itemsSnapshot, total, orderType, prefPretty);

      } catch (err){
        fail('Unexpected error', err);
      }
    });

    // Auto-fit inputs
    (function setupAutoFitInputs(){
      const form = document.getElementById('checkout-form');
      if(!form) return;
      const measurer = document.createElement('span');
      measurer.className = 'input-measure';
      document.body.appendChild(measurer);

      function fit(el){
        const text = el.value || el.placeholder || '';
        const cs = getComputedStyle(el);
        measurer.style.font = cs.font;
        measurer.style.padding = cs.padding;
        measurer.textContent = text + ' ';
        const px = measurer.getBoundingClientRect().width;
        const maxW = el.parentElement.getBoundingClientRect().width;
        el.style.width = Math.min(px + 4, maxW) + 'px';
      }
      function init(el){
        fit(el);
        ['input','change'].forEach(evt => el.addEventListener(evt, () => fit(el)));
        window.addEventListener('resize', () => fit(el));
      }
      form.querySelectorAll('input.auto-fit').forEach(init);
    })();

    // Recalculate open sections on resize (accordion)
    window.addEventListener('resize', () => {
      document.querySelectorAll('.category-body.open').forEach(b => {
        b.style.maxHeight = b.scrollHeight + 'px';
      });
    });
  </script>
  
<script>
  // ‚Ä¶ your Supabase / checkout code ‚Ä¶

  // ‚¨áÔ∏è put this somewhere after you've defined window.formatCurrency,
  // and before the closing </script> 
</script>

  <!-- Lightbox backdrop -->
  <div id="lightbox" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);align-items:center;justify-content:center;z-index:1500">
    <img id="lightbox-img" style="max-width:92%;max-height:92%;border-radius:8px;box-shadow:0 12px 40px rgba(0,0,0,0.6)" alt="">
  </div>
  <!-- jsPDF (client-side PDF generator) -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<!-- receipt helper (put this just before </body>) -->
<script>
(function () {
  // safety: currency helper
  if (typeof window.formatCurrency !== 'function') {
    window.formatCurrency = function (n) {
      return '¬£' + Number(n || 0).toFixed(2);
    };
  }

// ‚úÖ final, ASCII-safe, UTF-8 receipt
	window.downloadReceipt = function downloadReceipt(summary, items, preferredTimeStr) {
	  const pound = '\u00A3'; // ¬£
	  const bullet = '\u2022'; // ‚Ä¢
	  const colon = '\u003A'; // :

	  const noChilli = (s = '') =>
		s.replace(/üå∂Ô∏è/g, '').replace(/üå∂/g, '').replace(/\s{2,}/g, ' ').trim();

	  const lines = [];
	  lines.push("Rung's Thai Kitchen");
	  lines.push('----------------------------------------');
	  lines.push(`Order ref: ${summary?.ref || 'RTK-???'}`);
	  lines.push(`Total: ${pound}${(summary?.total || 0).toFixed(2)}`);
	  lines.push(`Type: ${summary?.orderType || ''}`);
	  if (preferredTimeStr) lines.push(`Preferred time: ${preferredTimeStr}`);
	  lines.push('');
	  lines.push('Items');

	  (items || []).forEach((row) => {
		const cleanName = noChilli(row.name || '');
		const qty = row.qty || 1;
		const lineTotal = (row.unitPrice || 0) * qty;
		lines.push(`${qty} √ó ${cleanName} ${pound}${lineTotal.toFixed(2)}`);

		const extras = [];
		if (Array.isArray(row.mods) && row.mods.length) {
		  extras.push(row.mods.map(m => m.name).join(', '));
		}
		if (typeof row.spice === 'number') {
		  const spiceText =
			row.spice === 0 ? 'None' :
			row.spice === 1 ? 'Mild' :
			row.spice === 2 ? 'Medium' : 'Hot';
		  extras.push(`Spice: ${spiceText}`);
		}
		if (extras.length) lines.push(`‚Ä¢ ${extras.join(' ‚Ä¢ ')}`);
	  });

	  lines.push('');
	  lines.push('Thank you for ordering with Rung\'s Thai Kitchen!');

	  // make .txt UTF-8
	  const blob = new Blob([lines.join('\n')], { type: 'text/plain;charset=utf-8' });
	  const url = URL.createObjectURL(blob);
	  const a = document.createElement('a');
	  a.href = url;
	  a.download = (summary?.ref || 'receipt') + '.txt';
	  document.body.appendChild(a);
	  a.click();
	  document.body.removeChild(a);
	  URL.revokeObjectURL(url);
	};


  // 3) wire the button on the success popup (if present)
  const btn = document.getElementById('order-success-download');
  if (btn) {
    btn.addEventListener('click', function () {
      if (!window._lastOrderSummary) {
        alert('No order to download yet.');
        return;
      }
      window.downloadReceipt(
        window._lastOrderSummary,
        window._lastOrderItems,
        window._lastOrderPreferredTime
      );
    });
  }
})();
</script>
<script>
// final, plain-text, no-chilli, Windows-friendly version
window.downloadReceiptPlain = function (summary, items, preferredTimeStr) {
  // helper: strip chilli emojis
  const stripSpice = (s = '') =>
    s.replace(/üå∂Ô∏è/g, '')
     .replace(/üå∂/g, '')
     .replace(/\s{2,}/g, ' ')
     .trim();

  const lines = [];
  lines.push("Rung's Thai Kitchen");
  lines.push('----------------------------------------');
  lines.push(`Order ref: ${summary?.ref || 'RTK-???'}`);

  const totalNum = Number(summary?.total || 0);
  const totalText = (typeof window.formatCurrency === 'function')
    ? window.formatCurrency(totalNum)
    : '¬£' + totalNum.toFixed(2);
  lines.push(`Total: ${totalText}`);

  if (summary?.orderType) {
    lines.push(`Type: ${summary.orderType}`);
  }
  if (preferredTimeStr) {
    lines.push(`Preferred time: ${preferredTimeStr}`);
  }

  lines.push('');
  lines.push('Items');

  (items || []).forEach(row => {
    const name = stripSpice(row.name || '');
    const qty  = row.qty || 1;
    const lineTotal = Number(qty) * Number(row.unitPrice || 0);
    const linePrice = (typeof window.formatCurrency === 'function')
      ? window.formatCurrency(lineTotal)
      : '¬£' + lineTotal.toFixed(2);

    // main line
    lines.push(`${qty} √ó ${name} ${linePrice}`);

    // extras line
    const extras = [];
    if (Array.isArray(row.mods) && row.mods.length) {
      extras.push(row.mods.map(m => m.name).join(', '));
    }
    if (typeof row.spice === 'number') {
      const spiceText =
        row.spice === 0 ? 'None' :
        row.spice === 1 ? 'Mild' :
        row.spice === 2 ? 'Medium' : 'Hot';
      extras.push(`Spice: ${spiceText}`);
    }
    if (extras.length) {
      lines.push('‚Ä¢ ' + extras.join(' ‚Ä¢ '));
    }
  });

  lines.push('');
  lines.push('Thank you!');

  // üëá add a BOM so Windows/Notepad knows it's UTF-8
  const BOM = '\uFEFF';
  const blob = new Blob([BOM + lines.join('\n')], {
    type: 'text/plain;charset=utf-8'
  });

  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = (summary?.ref || 'receipt') + '.txt';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
};
</script>

<script>
(function setupReceiptDownload() {
  const btn = document.getElementById('order-success-pdf');
  if (!btn) return;

  btn.addEventListener('click', () => {
    const payload = window.__lastOrderForPdf;
    if (!payload) {
      alert('No order data to export yet.');
      return;
    }

    const { summary, items, preferredTimeStr } = payload;

    // this should already be defined in your Supabase / checkout script
    if (typeof window.downloadReceipt === 'function') {
      window.downloadReceipt(summary, items, preferredTimeStr);
    } else {
      alert('Order: ' + (summary?.ref || 'RTK-???'));
    }
  });
})();
</script>


</body>
</html>
